<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <meta name="theme-color" content="#367C2B">
    <meta name="description" content="Your lawn care made simple - track, plan, and achieve the perfect green lawn">
    <title>Yardstick - Research-Backed Lawn Care</title>

```
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- ============================================================
     FIREBASE CONFIGURATION ‚Äî REPLACE PLACEHOLDERS BELOW
     Steps:
     1. Go to console.firebase.google.com
     2. Create project "Yardstick"
     3. Add a web app, copy the config object values below
     4. Enable Authentication > Google Sign-In + Email/Password
     5. Enable Firestore Database (production mode)
     6. Deploy Firestore security rules from FIREBASE_SETUP.md
     ============================================================ -->
<script type="module">
    const firebaseConfig = {
        apiKey:            "AIzaSyBYkHARramuf6Xwu0BGfxKqukHfw_OgePw",
        authDomain:        "lawn-tracker-71c43.firebaseapp.com",
        projectId:         "lawn-tracker-71c43",
        storageBucket:     "lawn-tracker-71c43.firebasestorage.app",
        messagingSenderId: "24765427828",
        appId:             "1:24765427828:web:d8e1229477658e4250e121"
    };

    const FIREBASE_CONFIGURED = !firebaseConfig.apiKey.startsWith('REPLACE');

    if (FIREBASE_CONFIGURED) {
        try {
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
            const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword,
                    createUserWithEmailAndPassword, signOut, onAuthStateChanged } =
                await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
            const { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc,
                    deleteDoc, serverTimestamp, query, orderBy } =
                await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

            const app = initializeApp(firebaseConfig);
            window.__FIREBASE__ = {
                auth: getAuth(app),
                db: getFirestore(app),
                GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword,
                createUserWithEmailAndPassword, signOut, onAuthStateChanged,
                doc, getDoc, setDoc, collection, getDocs, addDoc,
                deleteDoc, serverTimestamp, query, orderBy,
                configured: true
            };
        } catch(e) {
            console.error('Firebase init failed:', e);
            window.__FIREBASE__ = { configured: false };
        }
    } else {
        window.__FIREBASE__ = { configured: false };
        console.info('Yardstick: Firebase not configured ‚Äî running in local-only mode.');
    }

    // Signal React app that Firebase init is complete
    window.dispatchEvent(new Event('firebase-ready'));
</script>
```

</head>
<body class="bg-white" style="background-color: #ffffff !important;">
    <style>
        body::before,
        body > *:not(#root):not(script) { display: none !important; }
        #root { min-height: 100vh; }
        @keyframes slideUpBounce {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 4px 14px rgba(255, 222, 0, 0.4); }
            50% { box-shadow: 0 4px 24px rgba(255, 222, 0, 0.7); }
        }
        @keyframes fadeSlideIn {
            0% { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .animate-fade-in { animation: fadeSlideIn 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.25s ease-out; }
        .card-hover { transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .card-hover:active { transform: scale(0.98); }
        .btn-press { transition: transform 0.1s ease, opacity 0.1s ease; }
        .btn-press:active { transform: scale(0.95); opacity: 0.9; }
        .nav-item { transition: background-color 0.2s ease, color 0.2s ease; }
        .menu-slide { animation: fadeSlideIn 0.2s ease-out; }
        .cloud-badge {
            display: inline-flex; align-items: center; gap: 4px;
            background: linear-gradient(135deg, #e8f5e9, #f0fff4);
            border: 1px solid #367C2B; border-radius: 20px;
            padding: 2px 8px; font-size: 11px; font-weight: 700;
            color: #367C2B; white-space: nowrap;
        }
        .local-badge {
            display: inline-flex; align-items: center; gap: 4px;
            background: #f9f9f9; border: 1px solid #d1d5db;
            border-radius: 20px; padding: 2px 8px; font-size: 11px; font-weight: 700;
            color: #6b7280; white-space: nowrap;
        }
        .cite-btn {
            display: inline-flex; align-items: center; justify-content: center;
            width: 22px; height: 22px; border-radius: 50%; font-size: 11px; font-weight: 700;
            color: #367C2B; background: #e8f5e9; border: 1.5px solid #367C2B; cursor: pointer;
            line-height: 1; vertical-align: middle; margin-left: 4px; flex-shrink: 0;
            transition: background 0.15s ease, transform 0.1s ease;
            position: relative; z-index: 2; -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; user-select: none;
            min-width: 22px; min-height: 22px; padding: 0;
        }
        .cite-btn::before {
            content: ''; position: absolute; z-index: 2;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
        }
        .cite-btn:hover, .cite-btn:active { background: #367C2B; color: white; transform: scale(1.1); }
        .cite-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9998; }
        .cite-popup {
            position: fixed; z-index: 9999; background: white; border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.18); border: 1px solid #e0e0e0;
            padding: 12px 16px; max-width: 320px; min-width: 220px;
            animation: fadeSlideIn 0.15s ease-out;
        }
        .cite-popup a { color: #367C2B; text-decoration: underline; font-weight: 600; }
        .auth-modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 16px;
        }
        .auth-modal {
            background: white; border-radius: 20px; padding: 28px 24px;
            width: 100%; max-width: 400px; animation: scaleIn 0.2s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        }
        input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"], select, textarea {
            -webkit-appearance: none; appearance: none;
        }
    </style>
    <div id="root"></div>

```
<script src="grass-programs.js"></script>
<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ‚îÄ‚îÄ‚îÄ Firebase Data Layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Wraps all reads/writes so the rest of the app doesn't care whether
    // data lives in localStorage or Firestore.

    const useDataStore = (currentUser) => {
        const fb = window.__FIREBASE__ || {};
        const isCloud = fb.configured && !!currentUser;

        // ‚îÄ‚îÄ READ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const loadAll = useCallback(async () => {
            if (!isCloud) {
                return {
                    activities: JSON.parse(localStorage.getItem('lawnCareActivities') || '[]'),
                    equipment:  JSON.parse(localStorage.getItem('lawnCareEquipment')  || '[]'),
                    profile:    JSON.parse(localStorage.getItem('lawnProfile')         || 'null'),
                };
            }
            const uid = currentUser.uid;
            const { db, collection, getDocs, doc, getDoc } = fb;
            try {
                const [actSnap, eqSnap, profSnap] = await Promise.all([
                    getDocs(collection(db, 'users', uid, 'activities')),
                    getDocs(collection(db, 'users', uid, 'equipment')),
                    getDoc(doc(db, 'users', uid, 'profile', 'data')),
                ]);
                return {
                    activities: actSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    equipment:  eqSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    profile:    profSnap.exists() ? profSnap.data() : null,
                };
            } catch (e) {
                console.error('Firestore loadAll failed:', e);
                return { activities: [], equipment: [], profile: null };
            }
        }, [isCloud, currentUser]);

        // ‚îÄ‚îÄ WRITE activities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const saveActivity = useCallback(async (activity) => {
            if (!isCloud) {
                const stored = JSON.parse(localStorage.getItem('lawnCareActivities') || '[]');
                const updated = [...stored, activity];
                localStorage.setItem('lawnCareActivities', JSON.stringify(updated));
                return activity;
            }
            const { db, collection, addDoc, serverTimestamp } = fb;
            const ref = await addDoc(
                collection(fb.db, 'users', currentUser.uid, 'activities'),
                { ...activity, createdAt: serverTimestamp() }
            );
            return { ...activity, id: ref.id };
        }, [isCloud, currentUser]);

        const deleteActivity = useCallback(async (id) => {
            if (!isCloud) {
                const stored = JSON.parse(localStorage.getItem('lawnCareActivities') || '[]');
                localStorage.setItem('lawnCareActivities', JSON.stringify(stored.filter(a => a.id !== id)));
                return;
            }
            const { db, doc, deleteDoc } = fb;
            await deleteDoc(doc(db, 'users', currentUser.uid, 'activities', String(id)));
        }, [isCloud, currentUser]);

        // ‚îÄ‚îÄ WRITE equipment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const saveEquipment = useCallback(async (item) => {
            if (!isCloud) {
                const stored = JSON.parse(localStorage.getItem('lawnCareEquipment') || '[]');
                const updated = [...stored, item];
                localStorage.setItem('lawnCareEquipment', JSON.stringify(updated));
                return item;
            }
            const { db, collection, addDoc, serverTimestamp } = fb;
            const ref = await addDoc(
                collection(db, 'users', currentUser.uid, 'equipment'),
                { ...item, createdAt: serverTimestamp() }
            );
            return { ...item, id: ref.id };
        }, [isCloud, currentUser]);

        const deleteEquipment = useCallback(async (id) => {
            if (!isCloud) {
                const stored = JSON.parse(localStorage.getItem('lawnCareEquipment') || '[]');
                localStorage.setItem('lawnCareEquipment', JSON.stringify(stored.filter(e => e.id !== id)));
                return;
            }
            const { db, doc, deleteDoc } = fb;
            await deleteDoc(doc(db, 'users', currentUser.uid, 'equipment', String(id)));
        }, [isCloud, currentUser]);

        // ‚îÄ‚îÄ WRITE profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const saveProfile = useCallback(async (profile) => {
            localStorage.setItem('lawnProfile', JSON.stringify(profile)); // always cache locally
            if (!isCloud) return;
            const { db, doc, setDoc } = fb;
            await setDoc(doc(db, 'users', currentUser.uid, 'profile', 'data'), profile);
        }, [isCloud, currentUser]);

        return { loadAll, saveActivity, deleteActivity, saveEquipment, deleteEquipment, saveProfile, isCloud };
    };

    // ‚îÄ‚îÄ‚îÄ Auth Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const AuthModal = ({ onClose, onSuccess }) => {
        const [mode, setMode] = useState('signin'); // 'signin' | 'signup'
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const fb = window.__FIREBASE__;

        const handleGoogle = async () => {
            if (!fb.configured) return;
            setLoading(true); setError('');
            try {
                const provider = new fb.GoogleAuthProvider();
                const result = await fb.signInWithPopup(fb.auth, provider);
                onSuccess(result.user);
            } catch(e) {
                setError(e.message);
            } finally { setLoading(false); }
        };

        const handleEmail = async (e) => {
            e.preventDefault();
            if (!fb.configured) return;
            setLoading(true); setError('');
            try {
                let result;
                if (mode === 'signin') {
                    result = await fb.signInWithEmailAndPassword(fb.auth, email, password);
                } else {
                    result = await fb.createUserWithEmailAndPassword(fb.auth, email, password);
                }
                onSuccess(result.user);
            } catch(e) {
                const msg = e.code === 'auth/wrong-password'    ? 'Incorrect password.'
                          : e.code === 'auth/user-not-found'    ? 'No account with that email.'
                          : e.code === 'auth/email-already-in-use' ? 'Email already in use. Try signing in.'
                          : e.code === 'auth/weak-password'     ? 'Password must be at least 6 characters.'
                          : e.message;
                setError(msg);
            } finally { setLoading(false); }
        };

        return (
            <div className="auth-modal-bg" onClick={onClose}>
                <div className="auth-modal" onClick={e => e.stopPropagation()}>
                    {/* Logo */}
                    <div className="text-center mb-6">
                        <div className="text-4xl mb-2">üå±</div>
                        <div className="text-xl font-extrabold text-gray-900">Yardstick</div>
                        <div className="text-sm text-gray-500 mt-1">
                            {mode === 'signin' ? 'Sign in to sync your lawn data across devices' : 'Create a free account to save your data to the cloud'}
                        </div>
                    </div>

                    {/* Google button */}
                    <button
                        onClick={handleGoogle}
                        disabled={loading}
                        className="w-full flex items-center justify-center gap-3 py-3 px-4 border-2 border-gray-200 rounded-xl font-semibold text-gray-700 hover:border-gray-400 hover:bg-gray-50 transition mb-4 disabled:opacity-50"
                    >
                        <svg width="20" height="20" viewBox="0 0 48 48">
                            <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                            <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                            <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                            <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                        </svg>
                        Continue with Google
                    </button>

                    <div className="flex items-center gap-3 mb-4">
                        <div className="flex-1 h-px bg-gray-200"></div>
                        <span className="text-xs text-gray-400 font-semibold">OR</span>
                        <div className="flex-1 h-px bg-gray-200"></div>
                    </div>

                    {/* Email/password form */}
                    <form onSubmit={handleEmail} className="space-y-3">
                        <input
                            type="email" required placeholder="Email address"
                            value={email} onChange={e => setEmail(e.target.value)}
                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-[#367C2B] focus:outline-none"
                        />
                        <input
                            type="password" required placeholder="Password (min. 6 characters)"
                            value={password} onChange={e => setPassword(e.target.value)}
                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-[#367C2B] focus:outline-none"
                        />
                        {error && <div className="text-xs text-red-600 font-medium">{error}</div>}
                        <button
                            type="submit" disabled={loading}
                            className="w-full py-3 bg-[#367C2B] text-white rounded-xl font-bold text-sm disabled:opacity-50"
                        >
                            {loading ? '...' : mode === 'signin' ? 'Sign In' : 'Create Account'}
                        </button>
                    </form>

                    <div className="text-center mt-4">
                        <button
                            onClick={() => { setMode(mode === 'signin' ? 'signup' : 'signin'); setError(''); }}
                            className="text-sm text-[#367C2B] font-semibold"
                        >
                            {mode === 'signin' ? "Don't have an account? Sign up free" : 'Already have an account? Sign in'}
                        </button>
                    </div>

                    <button onClick={onClose} className="w-full mt-3 py-2 text-xs text-gray-400 hover:text-gray-600">
                        Continue without an account ‚Üí
                    </button>
                </div>
            </div>
        );
    };

    // ‚îÄ‚îÄ‚îÄ Sync Status Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SyncBanner = ({ isCloud, currentUser, onSignIn, onSignOut, firebaseConfigured }) => {
        const [expanded, setExpanded] = useState(false);

        if (!firebaseConfigured) return null; // Hide if Firebase not set up yet

        if (isCloud && currentUser) {
            const name = currentUser.displayName || currentUser.email || 'Account';
            return (
                <div className="bg-[#e8f5e9] border-b border-[#367C2B]/20 px-4 py-2">
                    <div className="max-w-5xl mx-auto flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <span className="cloud-badge">‚òÅÔ∏è Cloud Sync On</span>
                            <span className="text-xs text-gray-600 truncate max-w-[140px]">{name}</span>
                        </div>
                        <button onClick={onSignOut} className="text-xs font-semibold text-gray-500 hover:text-gray-700 underline">
                            Sign Out
                        </button>
                    </div>
                </div>
            );
        }

        return null;
    };

    // ‚îÄ‚îÄ‚îÄ Citation Badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const CitationBadge = ({ sources, label }) => {
        const [open, setOpen] = useState(false);
        if (!sources || sources.length === 0) return null;
        return (
            <span style={{position: 'relative', display: 'inline-block', verticalAlign: 'middle'}}>
                <button
                    className="cite-btn"
                    onClick={(e) => { e.preventDefault(); e.stopPropagation(); setOpen(!open); }}
                    aria-label={`Sources for ${label || 'this claim'}`}
                >i</button>
                {open && (
                    <React.Fragment>
                        <div className="cite-overlay" onClick={(e) => { e.preventDefault(); e.stopPropagation(); setOpen(false); }} />
                        <div className="cite-popup" style={{position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                                <div style={{fontSize: 11, fontWeight: 700, color: '#367C2B', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                    {label ? `Source: ${label}` : 'Sources'}
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); setOpen(false); }} style={{background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', color: '#999', padding: '0 0 0 8px', lineHeight: 1}}>√ó</button>
                            </div>
                            {sources.map((s, i) => (
                                <div key={i} style={{marginBottom: i < sources.length - 1 ? 8 : 0}}>
                                    {s.url ? (
                                        <a href={s.url} target="_blank" rel="noopener noreferrer" style={{fontSize: 13}}>
                                            {s.name || s.institution}
                                        </a>
                                    ) : (
                                        <span style={{fontSize: 13, fontWeight: 600, color: '#333'}}>{s.name || s.institution}</span>
                                    )}
                                    {(s.topic || s.title) && (
                                        <div style={{fontSize: 11, color: '#666', marginTop: 1}}>{s.topic || s.title}</div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </React.Fragment>
                )}
            </span>
        );
    };

    // ‚îÄ‚îÄ‚îÄ All the existing data constants (unchanged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PRODUCT_DATABASE = {
        mowers: [
            { id: 'm-other', name: 'Other (Specify)', brand: 'Other', mowerCategory: '', type: 'Custom', deck: '', features: '', maintenanceSchedule: { oilChange: null, note: 'Custom mower - set your own maintenance schedule' } },
            { id: 'wb1', name: 'Honda HRX217VKA', brand: 'Honda', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: 'Variable Speed, Versamow, GCV200', maintenanceSchedule: { oilChange: 50, airFilter: 50, sparkPlug: 100 } },
            { id: 'wb2', name: 'Honda HRN216VKA', brand: 'Honda', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: '3-in-1, Auto Choke, Twin Blade', maintenanceSchedule: { oilChange: 50, airFilter: 50, sparkPlug: 100 } },
            { id: 'wb3', name: 'Honda HRS216PKA', brand: 'Honda', mowerCategory: 'Walk Behind', type: 'Gas Push', deck: '21"', features: 'Reliable, Side Discharge', maintenanceSchedule: { oilChange: 50, airFilter: 50, sparkPlug: 100 } },
            { id: 'wb4', name: 'Toro Recycler 22" SmartStow', brand: 'Toro', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '22"', features: 'Personal Pace, SmartStow, Briggs 150cc', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 'yearly' } },
            { id: 'wb5', name: 'Toro Super Recycler 21"', brand: 'Toro', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: 'Personal Pace, PoweReverse, Cast Aluminum', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 'yearly' } },
            { id: 'wb6', name: 'Toro Recycler 21" 21352', brand: 'Toro', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: 'Briggs EXi 150cc, All-Wheel Drive', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 'yearly' } },
            { id: 'wb7', name: 'Toro TimeMaster 30"', brand: 'Toro', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '30"', features: 'Dual-Force Cutting, Personal Pace, Briggs 223cc', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 'yearly', bladeService: 'yearly' } },
            { id: 'wb8', name: 'EGO Power+ LM2142SP', brand: 'EGO', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '56V, 7.5Ah, LED Headlights, Select Cut', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb9', name: 'EGO Power+ LM2135SP', brand: 'EGO', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '56V, 5.0Ah, Touch Drive, Select Cut', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb10', name: 'Husqvarna LC221RH', brand: 'Husqvarna', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: 'Honda GCV160, Rear Wheel Drive, High Wheels', maintenanceSchedule: { oilChange: 50, airFilter: 50, sparkPlug: 100 } },
            { id: 'wb11', name: 'Husqvarna LC121P', brand: 'Husqvarna', mowerCategory: 'Walk Behind', type: 'Gas Push', deck: '21"', features: 'Briggs 163cc, 3-in-1', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 100 } },
            { id: 'wb12', name: 'Craftsman M215', brand: 'Craftsman', mowerCategory: 'Walk Behind', type: 'Gas Push', deck: '21"', features: 'Briggs & Stratton 140cc, Side Discharge', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 100 } },
            { id: 'wb13', name: 'Craftsman M230', brand: 'Craftsman', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: 'Briggs 163cc, Front-Wheel Drive', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 100 } },
            { id: 'wb14', name: 'Ryobi 40V RY40190', brand: 'Ryobi', mowerCategory: 'Walk Behind', type: 'Battery Push', deck: '20"', features: '40V Lithium 6Ah, Brushless Motor', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb15', name: 'Ryobi 40V RY401110', brand: 'Ryobi', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '40V Brushless, CrossCut Multi-Blade', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb16', name: 'Greenworks 25223', brand: 'Greenworks', mowerCategory: 'Walk Behind', type: 'Corded Electric', deck: '20"', features: '12 Amp, 3-in-1', maintenanceSchedule: { oilChange: null, note: 'Electric - no oil changes needed' } },
            { id: 'wb17', name: 'Greenworks Pro 80V 21"', brand: 'Greenworks', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '80V 4Ah, Brushless, Steel Deck', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb18', name: 'Makita XML08Z', brand: 'Makita', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '18V X2 (36V) LXT x4, Commercial Grade', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb19', name: 'Troy-Bilt TB330', brand: 'Troy-Bilt', mowerCategory: 'Walk Behind', type: 'Gas Self-Propelled', deck: '21"', features: 'TriAction Cutting, Briggs 163cc, Rear-Wheel Drive', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 100 } },
            { id: 'wb20', name: 'Milwaukee M18 FUEL 21"', brand: 'Milwaukee', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: 'M18 FUEL, Smart Speed Control', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb21', name: 'DeWalt DCMWSP244U2', brand: 'DeWalt', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21.5"', features: '2x 20V MAX, Rear Wheel Drive', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb22', name: 'Black+Decker BEMW472BH', brand: 'Black+Decker', mowerCategory: 'Walk Behind', type: 'Corded Electric', deck: '15"', features: '10 Amp, Lightweight, 6 Height Settings', maintenanceSchedule: { oilChange: null, note: 'Electric - no oil changes needed' } },
            { id: 'wb23', name: 'Kobalt 80V 21"', brand: 'Kobalt', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '80V 6Ah, Brushless, Quick-Fold Handle', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb24', name: 'Snapper XD 82V', brand: 'Snapper', mowerCategory: 'Walk Behind', type: 'Battery Self-Propelled', deck: '21"', features: '82V Lithium, StepSense Auto Drive', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'wb25', name: 'Worx WG779', brand: 'Worx', mowerCategory: 'Walk Behind', type: 'Battery Push', deck: '14"', features: '40V Power Share, Compact, Intellicut', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'rd1', name: 'John Deere S100', brand: 'John Deere', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '17.5 HP Briggs, Hydrostatic, Edge Cutting System', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd2', name: 'John Deere S130', brand: 'John Deere', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '22 HP V-Twin Briggs, Hydrostatic', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd3', name: 'John Deere S160', brand: 'John Deere', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '48"', features: '24 HP V-Twin ELS, Hydrostatic', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd4', name: 'John Deere S170', brand: 'John Deere', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '48"', features: '24 HP V-Twin, Cruise Control, Hydrostatic', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd5', name: 'John Deere X350', brand: 'John Deere', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '18.5 HP Kawasaki, Accel Deep Deck', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd6', name: 'Husqvarna YTH18542', brand: 'Husqvarna', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '18.5 HP Briggs, Hydrostatic, Air Induction', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd7', name: 'Husqvarna YTH24V48', brand: 'Husqvarna', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '48"', features: '24 HP Briggs V-Twin, Hydrostatic', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd8', name: 'Husqvarna YTH22V46', brand: 'Husqvarna', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '46"', features: '22 HP Briggs V-Twin, Pedal-Operated', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd10', name: 'Cub Cadet XT1 LT42', brand: 'Cub Cadet', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '18 HP Kohler, Hydrostatic, TightTurn', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd11', name: 'Cub Cadet XT1 LT46', brand: 'Cub Cadet', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '46"', features: '22 HP Kohler V-Twin, Hydrostatic', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'rd14', name: 'Craftsman T110', brand: 'Craftsman', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '17.5 HP Briggs, Hydrostatic, Turn Tight', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 100 } },
            { id: 'rd17', name: 'Troy-Bilt Pony 42"', brand: 'Troy-Bilt', mowerCategory: 'Riding', type: 'Lawn Tractor', deck: '42"', features: '15.5 HP Briggs, 7-Speed Manual', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 100 } },
            { id: 'rd24', name: 'Ryobi RYAC130-S', brand: 'Ryobi', mowerCategory: 'Riding', type: 'Electric Riding', deck: '30"', features: '50 Ah Battery, Brushless Motor', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'rd25', name: 'EGO Power+ T6', brand: 'EGO', mowerCategory: 'Riding', type: 'Electric Lawn Tractor', deck: '42"', features: '56V, Peak HP, Headlights, USB Port', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
            { id: 'zt1', name: 'John Deere Z335E', brand: 'John Deere', mowerCategory: 'Zero Turn', type: 'Residential ZTR', deck: '42"', features: '20 HP V-Twin, Accel Deep Deck', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'zt4', name: 'Husqvarna Z254', brand: 'Husqvarna', mowerCategory: 'Zero Turn', type: 'Residential ZTR', deck: '54"', features: '26 HP Kohler, ClearCut Deck', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'zt5', name: 'Husqvarna Z248F', brand: 'Husqvarna', mowerCategory: 'Zero Turn', type: 'Residential ZTR', deck: '48"', features: '23 HP Kawasaki, Stamped Deck', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'zt8', name: 'Toro TimeCutter 42"', brand: 'Toro', mowerCategory: 'Zero Turn', type: 'Residential ZTR', deck: '42"', features: '22.5 HP Toro V-Twin, MyRIDE, Smart Speed', maintenanceSchedule: { oilChange: 50, airFilter: 'yearly', sparkPlug: 'yearly' } },
            { id: 'zt10', name: 'Cub Cadet Ultima ZT1 42"', brand: 'Cub Cadet', mowerCategory: 'Zero Turn', type: 'Residential ZTR', deck: '42"', features: '22 HP Kohler V-Twin, High-Back Seat', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'zt13', name: 'Ariens IKON XD 42"', brand: 'Ariens', mowerCategory: 'Zero Turn', type: 'Residential ZTR', deck: '42"', features: '22 HP Kohler, Fabricated Deck', maintenanceSchedule: { oilChange: 50, airFilter: 100, sparkPlug: 100 } },
            { id: 'zt16', name: 'EGO Z6 42"', brand: 'EGO', mowerCategory: 'Zero Turn', type: 'Battery ZTR', deck: '42"', features: '56V, e-Steer, Brushless Motors', maintenanceSchedule: { oilChange: null, note: 'Battery-powered - no oil changes needed' } },
        ],
        spreaders: [
            { id: 'sp1', name: 'Echo RB-60 Spreader', brand: 'Echo', type: 'Broadcast', capacity: '60 lbs', features: 'Edge Guard, Pneumatic Tires', maintenanceSchedule: { cleaning: 'after each use', tires: 'check pressure 15 psi', note: 'Maintenance-free gear case' } },
            { id: 'sp2', name: 'Scotts Elite Spreader', brand: 'Scotts', type: 'Broadcast', capacity: '20000 sq ft', features: 'EdgeGuard, Never Flat Tires', maintenanceSchedule: { cleaning: 'after each use', note: 'No lubrication required' } },
            { id: 'sp3', name: 'Earthway 2150', brand: 'Earthway', type: 'Broadcast', capacity: '50 lbs', features: 'Commercial Grade, EV-N-Spred', maintenanceSchedule: { cleaning: 'after each use', lubrication: 'seasonal' } },
            { id: 'sp4', name: 'Agri-Fab 45-0463', brand: 'Agri-Fab', type: 'Tow-Behind', capacity: '130 lbs', features: 'Universal Hitch, Pneumatic Tires', maintenanceSchedule: { cleaning: 'after each use', lubrication: 'seasonal', tires: 'check pressure' } },
            { id: 'sp5', name: 'Chapin 8706A', brand: 'Chapin', type: 'Broadcast', capacity: '80 lbs', features: 'Auto-Stop, Baffle System', maintenanceSchedule: { cleaning: 'after each use', lubrication: 'before each season' } },
            { id: 'sp6', name: 'Scotts Wizz Hand-Held', brand: 'Scotts', type: 'Hand-Held', capacity: '2500 sq ft', features: 'Battery Powered, EdgeGuard', maintenanceSchedule: { cleaning: 'after each use', battery: 'charge as needed' } },
            { id: 'sp7', name: 'Lesco High Wheel', brand: 'Lesco', type: 'Broadcast', capacity: '80 lbs', features: 'Stainless Steel, Pro-Grade', maintenanceSchedule: { cleaning: 'after each use', lubrication: 'monthly during season' } },
            { id: 'sp10', name: 'Scotts Turf Builder EdgeGuard Mini', brand: 'Scotts', type: 'Broadcast', capacity: '5000 sq ft', features: 'Compact, EdgeGuard', maintenanceSchedule: { cleaning: 'after each use', note: 'Minimal maintenance' } }
        ],
        trimmers: [
            { id: 't-other', name: 'Other (Specify)', brand: 'Other', type: 'Custom', engineType: '', lineSize: '' },
            { id: 't1', name: 'Echo SRM-225', brand: 'Echo', type: 'Gas', engineType: 'Gas', lineSize: '.095"', features: '21.2cc, 2-Stroke' },
            { id: 't2', name: 'Stihl FS 56 RC-E', brand: 'Stihl', type: 'Gas', engineType: 'Gas', lineSize: '.105"', features: '27.2cc, Easy2Start' },
            { id: 't3', name: 'Husqvarna 128LD', brand: 'Husqvarna', type: 'Gas', engineType: 'Gas', lineSize: '.095"', features: '28cc, Detachable' },
            { id: 't4', name: 'EGO Power+ ST1521S', brand: 'EGO', type: 'Battery', engineType: 'Electric', lineSize: '.095"', features: '56V, Powerload' },
            { id: 't5', name: 'Makita XRU15Z', brand: 'Makita', type: 'Battery', engineType: 'Electric', lineSize: '.095"', features: '18V LXT' },
            { id: 't6', name: 'DeWalt DCST972X1', brand: 'DeWalt', type: 'Battery', engineType: 'Electric', lineSize: '.080"', features: '60V Max Flex' },
            { id: 't7', name: 'Ryobi RY40250', brand: 'Ryobi', type: 'Battery', engineType: 'Electric', lineSize: '.080"', features: '40V Brushless' },
            { id: 't8', name: 'Black+Decker LST136', brand: 'Black+Decker', type: 'Battery', engineType: 'Electric', lineSize: '.065"', features: '40V, Auto-Feed' },
            { id: 't9', name: 'Milwaukee 2825-21ST', brand: 'Milwaukee', type: 'Battery', engineType: 'Electric', lineSize: '.080"', features: 'M18 Fuel Quik-Lok' },
            { id: 't10', name: 'Craftsman CMXGTAMD25CC', brand: 'Craftsman', type: 'Gas', engineType: 'Gas', lineSize: '.095"', features: '25cc, 2-Cycle' }
        ],
        fertilizers: [
            { id: 'f1', name: 'Scotts Turf Builder Lawn Food', brand: 'Scotts', npk: '32-0-4', coverage: '15000 sq ft', type: 'Slow-Release Nitrogen' },
            { id: 'f2', name: 'Milorganite Organic Fertilizer', brand: 'Milorganite', npk: '6-4-0', coverage: '2500 sq ft', type: 'Organic, Slow-Release' },
            { id: 'f3', name: 'Jonathan Green Green-Up', brand: 'Jonathan Green', npk: '29-0-3', coverage: '15000 sq ft', type: 'Professional Grade' },
            { id: 'f4', name: 'Pennington UltraGreen', brand: 'Pennington', npk: '30-0-4', coverage: '12500 sq ft', type: 'Nitrogen Stabilized' },
            { id: 'f5', name: 'GreenView Fairway Formula', brand: 'GreenView', npk: '22-0-4', coverage: '15000 sq ft', type: 'Spring Booster' },
            { id: 'f6', name: 'Lesco Professional 24-0-11', brand: 'Lesco', npk: '24-0-11', coverage: '12500 sq ft', type: 'Balanced Formula' },
            { id: 'f8', name: 'Safer Brand Lawn Restore', brand: 'Safer Brand', npk: '9-0-2', coverage: '5000 sq ft', type: 'Organic, Pet-Safe' },
            { id: 'f10', name: 'Sunday Smart Lawn Care', brand: 'Sunday', npk: '11-0-0', coverage: '5000 sq ft', type: 'Custom Blend, Organic' }
        ],
        seeds: [
            { id: 's1', name: 'Scotts Turf Builder Grass Seed', brand: 'Scotts', type: 'Sun & Shade Mix', coverage: '2800 sq ft', variety: 'Tall Fescue Blend' },
            { id: 's2', name: 'Pennington Smart Seed', brand: 'Pennington', type: 'Dense Shade', coverage: '1200 sq ft', variety: 'Fine Fescue Mix' },
            { id: 's3', name: 'Jonathan Green Black Beauty', brand: 'Jonathan Green', type: 'Ultra Mix', coverage: '5600 sq ft', variety: 'Tall Fescue' },
            { id: 's6', name: 'Perennial Ryegrass Seed', brand: 'Barenbrug', type: 'RPR Technology', coverage: '5000 sq ft', variety: 'Quick Germination' },
            { id: 's7', name: 'Scotts EZ Seed Patch & Repair', brand: 'Scotts', type: 'Mulch Mix', coverage: '225 sq ft', variety: 'All-in-One' },
            { id: 's8', name: 'Zoysia Grass Seed', brand: 'Zenith', type: 'Warm Season', coverage: '2000 sq ft', variety: 'Drought Tolerant' },
            { id: 's9', name: 'Bermuda Grass Seed', brand: 'Outsidepride', type: 'Improved', coverage: '3000 sq ft', variety: 'Southern Lawns' },
            { id: 's10', name: 'Kentucky Bluegrass Mix', brand: 'Jonathan Green', type: 'Premium KBG', coverage: '3000 sq ft', variety: 'Fine Texture' }
        ]
    };

    const TREATMENT_PRODUCTS = {
        fertilizer: [
            { id: 'f1', name: 'Scotts Turf Builder Lawn Food', brand: 'Scotts', activeIngredient: '32-0-4', rate: 'Per label', timing: 'Spring/Fall', notes: 'Slow-Release Nitrogen' },
            { id: 'f2', name: 'Milorganite Organic Fertilizer', brand: 'Milorganite', activeIngredient: '6-4-0', rate: 'Per label', timing: 'Any season', notes: 'Organic, Slow-Release' },
            { id: 'f3', name: 'Jonathan Green Green-Up', brand: 'Jonathan Green', activeIngredient: '29-0-3', rate: 'Per label', timing: 'Spring/Fall', notes: 'Professional Grade' },
            { id: 'f4', name: 'Pennington UltraGreen', brand: 'Pennington', activeIngredient: '30-0-4', rate: 'Per label', timing: 'Growing season', notes: 'Nitrogen Stabilized' },
            { id: 'f5', name: 'Other (specify)', brand: 'Various', activeIngredient: '', rate: 'See label', timing: '', notes: 'Custom product' }
        ],
        preemergent: [
            { id: 'pre1', name: 'Prodiamine 65 WDG (Yard Mastery)', brand: 'Yard Mastery', activeIngredient: 'Prodiamine 65%', rate: '0.5 oz per 1,000 sq ft', timing: 'When soil hits 50-55¬∞F', notes: 'Premium WDG formulation' },
            { id: 'pre2', name: 'Barricade 4FL', brand: 'Syngenta', activeIngredient: 'Prodiamine 41.7%', rate: '0.5 fl oz per 1,000 sq ft', timing: 'Early spring & fall', notes: 'Liquid concentrate' },
            { id: 'pre3', name: 'Dimension 2EW', brand: 'Dow', activeIngredient: 'Dithiopyr 23.3%', rate: '0.5 fl oz per 1,000 sq ft', timing: 'Pre & early post-emergent', notes: 'Works on young crabgrass' },
            { id: 'pre4', name: 'Scotts Halts', brand: 'Scotts', activeIngredient: 'Pendimethalin', rate: '2.9 lbs per 1,000 sq ft', timing: 'Early spring', notes: 'Granular, easy application' },
            { id: 'pre5', name: 'Other (specify)', brand: 'Various', activeIngredient: '', rate: 'See label', timing: '', notes: 'Custom product' }
        ],
        postemergent: [
            { id: 'post1', name: 'Tenacity', brand: 'Syngenta', activeIngredient: 'Mesotrione 40%', rate: '0.25 oz per 1,000 sq ft', target: 'Crabgrass, broadleaf weeds', notes: 'Safe for seeding' },
            { id: 'post2', name: 'Ortho Weed B Gon', brand: 'Ortho', activeIngredient: '2,4-D + Quinclorac', rate: 'Per label', target: 'Broadleaf & grassy weeds', notes: 'Ready-to-spray' },
            { id: 'post3', name: 'Speedzone', brand: 'PBI Gordon', activeIngredient: '2,4-D + others', rate: '1.5 fl oz per 1,000 sq ft', target: 'Fast-acting broadleaf', notes: 'Works in cool temps' },
            { id: 'post4', name: 'Quinclorac 75DF', brand: 'Various', activeIngredient: 'Quinclorac 75%', rate: '0.25 oz per 1,000 sq ft', target: 'Crabgrass, clover', notes: 'Selective herbicide' },
            { id: 'post5', name: 'Other (specify)', brand: 'Various', activeIngredient: '', rate: 'See label', target: '', notes: 'Custom product' }
        ],
        fungicide: [
            { id: 'fung1', name: 'Disease Ex (Scotts)', brand: 'Scotts', activeIngredient: 'Azoxystrobin 0.31%', rate: '3 lbs per 1,000 sq ft', target: 'Brown patch, dollar spot', notes: 'Granular, preventative' },
            { id: 'fung2', name: 'Azoxystrobin 0.31G', brand: 'Various', activeIngredient: 'Azoxystrobin 0.31%', rate: '3 lbs per 1,000 sq ft', target: 'Broad spectrum', notes: 'Generic Disease Ex' },
            { id: 'fung3', name: 'Propiconazole 14.3', brand: 'Various', activeIngredient: 'Propiconazole 14.3%', rate: '1 fl oz per 1,000 sq ft', target: 'Systemic fungicide', notes: 'Liquid concentrate' },
            { id: 'fung5', name: 'Other (specify)', brand: 'Various', activeIngredient: '', rate: 'See label', target: '', notes: 'Custom product' }
        ],
        insecticide: [
            { id: 'ins1', name: 'GrubEx (Scotts)', brand: 'Scotts', activeIngredient: 'Chlorantraniliprole', rate: '2.87 lbs per 1,000 sq ft', target: 'Grubs (preventative)', notes: 'Apply late spring/early summer' },
            { id: 'ins2', name: 'BioAdvanced Grub Killer', brand: 'BioAdvanced', activeIngredient: 'Imidacloprid', rate: '3 lbs per 1,000 sq ft', target: 'Grubs, mole crickets', notes: 'Season-long control' },
            { id: 'ins3', name: 'Dylox 6.2G', brand: 'Bayer', activeIngredient: 'Trichlorfon 6.2%', rate: '3 lbs per 1,000 sq ft', target: 'Active grubs', notes: '24-hour curative' },
            { id: 'ins5', name: 'Other (specify)', brand: 'Various', activeIngredient: '', rate: 'See label', target: '', notes: 'Custom product' }
        ],
        soilAmendment: [
            { id: 'soil1', name: 'Pelletized Lime', brand: 'Various', type: 'pH Increase', rate: '50 lbs per 1,000 sq ft', effect: 'Raises pH by ~0.5', notes: 'For acidic soils (pH <6.5)' },
            { id: 'soil2', name: 'Elemental Sulfur', brand: 'Various', type: 'pH Decrease', rate: '5-10 lbs per 1,000 sq ft', effect: 'Lowers pH by ~0.5', notes: 'For alkaline soils (pH >7.0)' },
            { id: 'soil3', name: 'Gypsum', brand: 'Various', type: 'Soil Structure', rate: '40 lbs per 1,000 sq ft', effect: 'Improves clay soil', notes: 'Does not change pH' },
            { id: 'soil4', name: 'Humic Acid', brand: 'Various', type: 'Soil Health', rate: '3 fl oz per 1,000 sq ft', effect: 'Improves nutrient uptake', notes: 'Liquid application' },
            { id: 'soil5', name: 'Other (specify)', brand: 'Various', type: '', rate: 'See label', effect: '', notes: 'Custom product' }
        ]
    };

    const TREATMENT_CATEGORIES = {
        fertilizer: { label: 'Fertilizer', icon: 'üåæ', description: 'NPK nutrients for growth' },
        preemergent: { label: 'Pre-Emergent', icon: 'üõ°Ô∏è', description: 'Prevent weed seeds' },
        postemergent: { label: 'Post-Emergent', icon: 'üåø', description: 'Kill existing weeds' },
        fungicide: { label: 'Fungicide', icon: 'üçÑ', description: 'Prevent/treat diseases' },
        insecticide: { label: 'Insecticide', icon: 'üêõ', description: 'Control grubs/insects' },
        soilAmendment: { label: 'Soil Amendment', icon: 'üåç', description: 'Adjust pH/improve soil' }
    };

    const ACTIVITY_TYPES = {
        mowing: {
            name: 'Mowing Lawn', icon: 'üå±', color: 'bg-[#367C2B]',
            fields: [
                { name: 'mowerType', label: 'Mower Type', type: 'select', options: ['Walk Behind', 'Riding', 'Zero Turn'] },
                { name: 'mowerUsed', label: 'Mower Model', type: 'product-select', productType: 'mowers', filterBy: 'mowerType', filterProp: 'mowerCategory' },
                { name: 'mowHeight', label: 'Mow Height', type: 'select', options: ['1.5"', '2"', '2.5"', '3"', '3.5"', '4"'] },
                { name: 'clippings', label: 'Clippings', type: 'select', options: ['Bagging', 'Mulching', 'Side Discharge'] },
                { name: 'duration', label: 'Duration (minutes)', type: 'number', placeholder: '45' }
            ]
        },
        fertilizer: {
            name: 'Fertilizer & Treatments', icon: 'üåæ', color: 'bg-[#367C2B]',
            fields: [
                { name: 'category', label: 'Treatment Category', type: 'treatment-category', required: true },
                { name: 'product', label: 'Product', type: 'treatment-product', required: true },
                { name: 'spreader', label: 'Spreader (Optional)', type: 'product-select', productType: 'spreaders' },
                { name: 'spreaderSetting', label: 'Spreader Setting', type: 'text', placeholder: 'e.g., 3.5, D, or 14' },
                { name: 'applicationRate', label: 'Application Rate', type: 'text', placeholder: '0.5 oz per 1,000 sq ft' },
                { name: 'coverage', label: 'Coverage (sq ft)', type: 'number', placeholder: '5000' }
            ]
        },
        trimming: {
            name: 'Trimming Beds', icon: '‚úÇÔ∏è', color: 'bg-[#367C2B]',
            fields: [
                { name: 'areas', label: 'Areas Trimmed', type: 'text' },
                { name: 'toolUsed', label: 'Tool Used', type: 'select', options: ['String Trimmer', 'Edger', 'Hedge Trimmer'] }
            ]
        },
        watering: {
            name: 'Watering', icon: 'üíß', color: 'bg-[#367C2B]',
            fields: [
                { name: 'method', label: 'Method', type: 'select', options: ['Sprinkler System', 'Hose', 'Hand Watering'] },
                { name: 'duration', label: 'Duration (minutes)', type: 'number' }
            ]
        },
        seeding: {
            name: 'Seeding/Overseeding', icon: 'üå±', color: 'bg-[#367C2B]',
            fields: [
                { name: 'product', label: 'Grass Seed', type: 'product-select', productType: 'seeds' },
                { name: 'spreader', label: 'Spreader (Optional)', type: 'product-select', productType: 'spreaders' },
                { name: 'spreaderSetting', label: 'Spreader Setting', type: 'text', placeholder: 'e.g., 3.5, D, or 14' },
                { name: 'amountUsed', label: 'Amount Used (lbs)', type: 'number' }
            ]
        },
        aeration: {
            name: 'Aeration', icon: 'üîß', color: 'bg-[#367C2B]',
            fields: [
                { name: 'method', label: 'Method', type: 'select', options: ['Core Aeration', 'Spike Aeration', 'Liquid Aeration'] },
                { name: 'coverage', label: 'Coverage (sq ft)', type: 'number' }
            ]
        },
        maintenance: {
            name: 'Equipment Maintenance', icon: 'üîß', color: 'bg-[#367C2B]',
            fields: [
                { name: 'equipmentType', label: 'Equipment', type: 'select', options: ['Mower', 'Trimmer', 'Edger', 'Blower', 'Other'] },
                { name: 'maintenanceType', label: 'Maintenance', type: 'select', options: ['Oil Change', 'Blade Sharpening', 'Spark Plug', 'Air Filter', 'Cleaning'] }
            ]
        }
    };

    const ACTIVITY_COLORS = {
        mowing:      { bg: 'bg-[#367C2B]/10', border: 'border-[#367C2B]', text: 'text-[#367C2B]', hex: '#367C2B' },
        fertilizer:  { bg: 'bg-orange-50',    border: 'border-[#F97316]', text: 'text-[#F97316]', hex: '#F97316' },
        trimming:    { bg: 'bg-emerald-50',   border: 'border-emerald-500', text: 'text-emerald-600', hex: '#10B981' },
        watering:    { bg: 'bg-blue-50',       border: 'border-[#3B82F6]', text: 'text-[#3B82F6]', hex: '#3B82F6' },
        seeding:     { bg: 'bg-amber-50',      border: 'border-[#92400E]', text: 'text-[#92400E]', hex: '#92400E' },
        aeration:    { bg: 'bg-purple-50',     border: 'border-purple-500', text: 'text-purple-600', hex: '#8B5CF6' },
        maintenance: { bg: 'bg-gray-50',       border: 'border-[#6B7280]', text: 'text-[#6B7280]', hex: '#6B7280' }
    };

    const RESEARCH_SOURCES = [
        { id: 'psu', name: 'Penn State Extension', count: 8, url: 'https://extension.psu.edu/', topics: 'Tall Fescue, Kentucky Bluegrass, Cool-Season Care, Fertilization, Mowing Heights' },
        { id: 'purdue', name: 'Purdue Extension', count: 6, url: 'https://www.purdue.edu/hla/sites/turf/', topics: 'Cool-Season Grasses, Lawn Establishment, Disease Management' },
        { id: 'ncstate', name: 'NC State Extension', count: 12, url: 'https://content.ces.ncsu.edu/', topics: 'Transition Zone Management, Tall Fescue Heat Tolerance, Bermudagrass, Zoysiagrass, Centipedegrass' },
        { id: 'uga', name: 'University of Georgia Extension', count: 10, url: 'https://extension.uga.edu/', topics: 'Warm-Season Grasses, Bermudagrass Varieties, St. Augustine Care, Disease Control' },
        { id: 'tamu', name: 'Texas A&M AgriLife Extension', count: 9, url: 'https://agrilifeextension.tamu.edu/', topics: 'Bermudagrass, St. Augustine, Zoysiagrass, Heat Management, Drought Tolerance' },
        { id: 'msu', name: 'Michigan State Extension', count: 5, url: 'https://www.canr.msu.edu/turf/', topics: 'Cool-Season Grasses, Northern Climate Management, Kentucky Bluegrass' },
        { id: 'clemson', name: 'Clemson Extension', count: 7, url: 'https://www.clemson.edu/extension/', topics: 'Transition Zone, Centipedegrass, Tall Fescue in Heat, Bermudagrass Spring Dead Spot' },
        { id: 'vt', name: 'Virginia Tech Extension', count: 6, url: 'https://ext.vt.edu/', topics: 'Transition Zone Grasses, Tall Fescue Varieties, Bermudagrass Cold Hardiness' },
        { id: 'ufl', name: 'University of Florida IFAS', count: 8, url: 'https://sfyl.ifas.ufl.edu/', topics: 'St. Augustine, Bahiagrass, Centipedegrass, Year-Round Management' },
        { id: 'kstate', name: 'Kansas State Extension', count: 5, url: 'https://www.bookstore.ksre.ksu.edu/', topics: 'Bermudagrass Cold Tolerance, Transition Zone, Zoysiagrass' },
        { id: 'umn', name: 'University of Minnesota Extension', count: 4, url: 'https://extension.umn.edu/', topics: 'Kentucky Bluegrass, Cool-Season Grasses, Zone 4 Management' },
        { id: 'lsu', name: 'LSU AgCenter', count: 6, url: 'https://www.lsuagcenter.com/', topics: 'Warm-Season Grasses, Centipedegrass, St. Augustine, High Humidity Management' },
        { id: 'osu', name: 'Ohio State Extension', count: 5, url: 'https://ohioline.osu.edu/', topics: 'Cool-Season Grasses, Tall Fescue, Kentucky Bluegrass, Midwest Climate' },
        { id: 'rutgers', name: 'Rutgers Cooperative Extension', count: 4, url: 'https://njaes.rutgers.edu/', topics: 'Cool-Season Turf, Disease Management, Fine Fescues' },
        { id: 'uark', name: 'University of Arkansas Extension', count: 4, url: 'https://www.uaex.uada.edu/', topics: 'Transition Zone, Bermudagrass, Zoysiagrass, Tall Fescue' },
        { id: 'uconn', name: 'UConn Extension', count: 3, url: 'https://extension.uconn.edu/', topics: 'Cool-Season Grasses, Fine Fescues, Northeast Climate' },
        { id: 'aces', name: 'Alabama Cooperative Extension', count: 5, url: 'https://www.aces.edu/', topics: 'Warm-Season Grasses, Bermudagrass, Centipedegrass, Southeast Climate' },
        { id: 'okstate', name: 'Oklahoma State Extension', count: 4, url: 'https://extension.okstate.edu/', topics: 'Bermudagrass, Transition Zone, Drought Management' },
        { id: 'umass', name: 'UMass Extension', count: 3, url: 'https://ag.umass.edu/turf', topics: 'Cool-Season Grasses, Sports Turf, Northern Management' }
    ];

    const GRASS_INFO = {
        'tall-fescue': {
            name: 'Tall Fescue', season: 'Cool Season',
            mowHeight: '3 - 4 inches', mowHeightSummer: '3.5 - 4 inches',
            waterPerWeek: '1 - 1.5 inches', idealSoilPH: '5.8 - 6.5',
            idealSoilTemp: '50 - 65¬∞F for growth', sunNeeds: 'Full sun to partial shade (4-6 hrs)',
            fertPerYear: '3 - 4 lbs N per 1,000 sq ft', peakGrowth: 'Spring & Fall',
            dormancy: 'May slow/brown in summer heat',
            bestFeature: 'Deep root system, excellent drought tolerance for a cool-season grass',
            commonIssues: ['Brown patch in humid summers', 'Pythium blight in wet conditions', 'Can thin in heavy shade'],
            keyTips: ['September is the #1 most important month - fertilize heavily and overseed', 'Raise mowing height in summer to reduce heat stress', 'Never remove more than 1/3 of the blade at a time', 'Core aerate in fall for best results'],
            zoneNotes: { '4': 'Excellent choice - very cold hardy. Focus on spring/fall feeding.', '5': 'Ideal zone. Standard cool-season program works perfectly.', '6': 'Great performance. Watch for brown patch in humid summers.', '7': 'Transition zone - use heat-tolerant varieties (Firecracker LS, Mustang 4). Summer stress is real.', '8': 'Challenging - will struggle in summer. Consider warm-season alternatives.', '9': 'Not recommended - too hot. Switch to bermuda, zoysia, or st. augustine.' },
            sources: [{ name: 'Penn State Extension', url: 'https://extension.psu.edu/lawn-care', topic: 'Tall Fescue Lawn Maintenance Calendar' }, { name: 'Purdue Extension', url: 'https://www.purdue.edu/hla/sites/turf/tall-fescue/', topic: 'Tall Fescue Management' }, { name: 'NC State Extension', url: 'https://content.ces.ncsu.edu/carolina-lawns', topic: 'Carolina Lawns: Tall Fescue' }]
        },
        'kentucky-bluegrass': {
            name: 'Kentucky Bluegrass', season: 'Cool Season',
            mowHeight: '2.5 - 3.5 inches', mowHeightSummer: '3 - 3.5 inches',
            waterPerWeek: '1 - 1.5 inches', idealSoilPH: '6.0 - 7.0',
            idealSoilTemp: '50 - 65¬∞F for growth', sunNeeds: 'Full sun (6+ hours)',
            fertPerYear: '3 - 5 lbs N per 1,000 sq ft', peakGrowth: 'Spring & Fall',
            dormancy: 'Goes dormant in summer heat (turns brown, recovers in fall)',
            bestFeature: 'Self-repairing via rhizomes - fills in bare spots naturally',
            commonIssues: ['Dollar spot', 'Summer patch', 'Necrotic ring spot', 'Needs more water than fescue'],
            keyTips: ['Needs more sun than fescue - struggles below 6 hours direct sun', 'Will go dormant in summer but bounces back in fall', 'Slow to establish from seed (14-30 days germination)', 'Fall is the best time to seed and fertilize heavily'],
            zoneNotes: { '4': 'Premium choice - thrives in cold climates. The classic northern lawn grass.', '5': 'Excellent. Standard KBG program works great.', '6': 'Good but expect summer dormancy in hot years.', '7': 'Difficult - summer stress is significant. Blend with tall fescue.', '8': 'Not recommended without irrigation and shade.', '9': 'Not viable - too hot.' },
            sources: [{ name: 'Penn State Extension', url: 'https://extension.psu.edu/lawn-care', topic: 'Kentucky Bluegrass Lawn Maintenance' }, { name: 'Michigan State Extension', url: 'https://www.canr.msu.edu/turf/kentucky-bluegrass', topic: 'Kentucky Bluegrass Care' }, { name: 'University of Minnesota Extension', url: 'https://extension.umn.edu/lawn-care/kentucky-bluegrass', topic: 'KBG for Northern Climates' }]
        },
        'perennial-ryegrass': {
            name: 'Perennial Ryegrass', season: 'Cool Season',
            mowHeight: '1.5 - 2.5 inches', mowHeightSummer: '2.5 - 3 inches',
            waterPerWeek: '1 inch', idealSoilPH: '6.0 - 7.0',
            idealSoilTemp: '50 - 65¬∞F for growth', sunNeeds: 'Full sun to light shade',
            fertPerYear: '2 - 4 lbs N per 1,000 sq ft', peakGrowth: 'Spring & Fall',
            dormancy: 'Poor heat tolerance - can die in extreme heat',
            bestFeature: 'Fastest germination (5-10 days) - great for quick fill and overseeding',
            commonIssues: ['Gray leaf spot', 'Pythium blight', 'Poor heat/drought tolerance', 'Crown rust'],
            keyTips: ['Best used in blends with KBG or fescue rather than as a standalone', 'Excellent for overseeding warm-season lawns in winter', 'Germinates very fast - great for quick repairs', 'Mow frequently to maintain density'],
            zoneNotes: { '4': 'Good in blends. Can winterkill in extreme cold.', '5': 'Works well in blends with KBG.', '6': 'Good for blends and overseeding.', '7': 'Best as winter overseed for warm-season lawns.', '8': 'Winter overseed only.', '9': 'Winter overseed only.' },
            sources: [{ name: 'Rutgers Cooperative Extension', url: 'https://njaes.rutgers.edu/fs1316/', topic: 'Perennial Ryegrass Turf Management' }, { name: 'Penn State Extension', url: 'https://extension.psu.edu/lawn-care', topic: 'Perennial Ryegrass Maintenance' }]
        },
        'bermuda': {
            name: 'Bermudagrass', season: 'Warm Season',
            mowHeight: '0.5 - 2 inches', mowHeightSummer: '1 - 2 inches',
            waterPerWeek: '1 - 1.25 inches', idealSoilPH: '6.0 - 6.5',
            idealSoilTemp: '65¬∞F+ for active growth', sunNeeds: 'Full sun required (8+ hours ideal)',
            fertPerYear: '3 - 5 lbs N per 1,000 sq ft', peakGrowth: 'Summer (June - August)',
            dormancy: 'Goes dormant and turns brown below 50¬∞F',
            bestFeature: 'Extremely aggressive growth - repairs damage quickly, excellent traffic tolerance',
            commonIssues: ['Spring dead spot', 'Large patch', 'Invasive into flower beds', 'Winter dormancy (brown)'],
            keyTips: ['Do NOT fertilize until fully greened up in spring (soil 65¬∞F+)', 'Mow low and frequently for the best lawn', 'Scalp in early spring to remove brown thatch and speed green-up', 'Apply pre-emergent in late February/early March'],
            zoneNotes: { '4': 'Not viable - too cold.', '5': 'Not recommended - winter damage is likely.', '6': 'Marginal - only cold-hardy varieties (Latitude 36, NorthBridge).', '7': 'Good with cold-hardy varieties. Expect 4-5 months dormancy.', '8': 'Excellent - this is bermuda country.', '9': 'Excellent - thrives with proper management.' },
            sources: [{ name: 'NC State Extension', url: 'https://content.ces.ncsu.edu/carolina-lawns', topic: 'Bermudagrass Maintenance' }, { name: 'Texas A&M AgriLife', url: 'https://agrilifeextension.tamu.edu/bermudagrass/', topic: 'Bermudagrass Management Guide' }, { name: 'UGA Extension', url: 'https://extension.uga.edu/publications/lawn-garden.html', topic: 'Bermudagrass Calendar' }]
        },
        'zoysia': {
            name: 'Zoysiagrass', season: 'Warm Season',
            mowHeight: '1 - 2 inches', mowHeightSummer: '1.5 - 2 inches',
            waterPerWeek: '0.75 - 1 inch', idealSoilPH: '6.0 - 6.5',
            idealSoilTemp: '65¬∞F+ for active growth', sunNeeds: 'Full sun to moderate shade (4+ hours)',
            fertPerYear: '2 - 3 lbs N per 1,000 sq ft', peakGrowth: 'Late Spring - Summer',
            dormancy: 'Goes dormant below 55¬∞F - turns golden brown',
            bestFeature: 'Dense, carpet-like texture with good shade tolerance for a warm-season grass',
            commonIssues: ['Large patch disease', 'Slow to establish', 'Heavy thatch buildup', 'Slow spring green-up'],
            keyTips: ['Patience required - zoysia is slow to spread and fill in', 'Dethatch or core aerate regularly to prevent thatch buildup', 'Needs less fertilizer than bermuda - don\'t over-feed', 'Last to green up in spring and first to go dormant in fall'],
            zoneNotes: { '4': 'Not recommended - too cold.', '5': 'Marginal - only the hardiest varieties (Zenith, Meyer).', '6': 'Good option with cold-hardy varieties. Expect long dormancy.', '7': 'Excellent transition zone choice - good compromise grass.', '8': 'Excellent performance.', '9': 'Good but bermuda or st. augustine may perform better.' },
            sources: [{ name: 'Kansas State Extension', url: 'https://www.bookstore.ksre.ksu.edu/pubs/MF3280.pdf', topic: 'Zoysiagrass Lawn Care' }, { name: 'Clemson Extension', url: 'https://www.clemson.edu/extension/hgic/plants/landscape/lawns/hgic1214.html', topic: 'Zoysiagrass Maintenance' }, { name: 'NC State Extension', url: 'https://content.ces.ncsu.edu/carolina-lawns', topic: 'Zoysiagrass in the Transition Zone' }]
        },
        'st-augustine': {
            name: 'St. Augustinegrass', season: 'Warm Season',
            mowHeight: '3 - 4 inches', mowHeightSummer: '3.5 - 4 inches',
            waterPerWeek: '1 - 1.5 inches', idealSoilPH: '6.0 - 6.5',
            idealSoilTemp: '65¬∞F+ for active growth', sunNeeds: 'Full sun to moderate shade (best warm-season shade tolerance)',
            fertPerYear: '2 - 4 lbs N per 1,000 sq ft', peakGrowth: 'Summer',
            dormancy: 'Goes dormant below 55¬∞F, sensitive to freeze damage',
            bestFeature: 'Best shade tolerance of any warm-season grass - thick, lush growth',
            commonIssues: ['Chinch bugs (major pest)', 'Gray leaf spot', 'SAD virus (St. Augustine Decline)', 'Poor cold tolerance'],
            keyTips: ['Must be established by sod or plugs - no viable seed available', 'Keep mowing height high (3.5-4") for healthiest lawn', 'Watch closely for chinch bug damage in hot, dry periods', 'Do not over-fertilize with nitrogen - increases disease risk'],
            zoneNotes: { '4': 'Not viable.', '5': 'Not viable.', '6': 'Not viable - no cold tolerance.', '7': 'Very risky - freeze damage likely.', '8': 'Good in southern Zone 8. Protect from hard freezes.', '9': 'Excellent - ideal climate for st. augustine.' },
            sources: [{ name: 'UF/IFAS Extension', url: 'https://edis.ifas.ufl.edu/topic-st-augustinegrass', topic: 'St. Augustinegrass for Florida Lawns' }, { name: 'Texas A&M AgriLife', url: 'https://agrilifeextension.tamu.edu/st-augustinegrass/', topic: 'St. Augustinegrass Management' }, { name: 'LSU AgCenter', url: 'https://www.lsuagcenter.com/topics/lawn_garden/lawns', topic: 'St. Augustinegrass Care' }]
        }
    };

    const ZONE_INFO = {
        '4':  { temp: '-30 to -20¬∞F', climate: 'Northern Cold',      description: 'Long, cold winters. Short growing season. Cool-season grasses only.',                                              lastFrost: { month: 5, day: 10 }, firstFrost: { month: 9, day: 20 }, growingDays: 133 },
        '4a': { temp: '-30 to -25¬∞F', climate: 'Northern Cold',      description: 'Extreme cold winters. Short growing season. Cool-season grasses only.',                                           lastFrost: { month: 5, day: 15 }, firstFrost: { month: 9, day: 15 }, growingDays: 123 },
        '4b': { temp: '-25 to -20¬∞F', climate: 'Northern Cold',      description: 'Very cold winters. Short growing season. Cool-season grasses only.',                                              lastFrost: { month: 5, day: 5  }, firstFrost: { month: 9, day: 25 }, growingDays: 143 },
        '5':  { temp: '-20 to -10¬∞F', climate: 'Northern',           description: 'Cold winters, moderate summers. Ideal for cool-season grasses.',                                                  lastFrost: { month: 4, day: 25 }, firstFrost: { month: 10, day: 5 }, growingDays: 163 },
        '5a': { temp: '-20 to -15¬∞F', climate: 'Northern',           description: 'Cold winters, moderate summers. Ideal for cool-season grasses.',                                                  lastFrost: { month: 4, day: 30 }, firstFrost: { month: 10, day: 1 }, growingDays: 154 },
        '5b': { temp: '-15 to -10¬∞F', climate: 'Northern',           description: 'Cold winters, moderate summers. Ideal for cool-season grasses.',                                                  lastFrost: { month: 4, day: 20 }, firstFrost: { month: 10, day: 10 }, growingDays: 173 },
        '6':  { temp: '-10 to 0¬∞F',   climate: 'Moderate',           description: 'Moderate winters. Good for cool-season grasses, some warm-season with care.',                                    lastFrost: { month: 4, day: 10 }, firstFrost: { month: 10, day: 22 }, growingDays: 195 },
        '6a': { temp: '-10 to -5¬∞F',  climate: 'Moderate',           description: 'Moderate winters, cooler half. Great for cool-season grasses; warm-season marginal.',                           lastFrost: { month: 4, day: 15 }, firstFrost: { month: 10, day: 18 }, growingDays: 186 },
        '6b': { temp: '-5 to 0¬∞F',    climate: 'Moderate',           description: 'Moderate winters, warmer half. Cool-season grasses excel; select warm-season varieties possible.',              lastFrost: { month: 4, day: 5  }, firstFrost: { month: 10, day: 28 }, growingDays: 206 },
        '7':  { temp: '0 to 10¬∞F',    climate: 'Transition Zone',    description: 'The toughest zone for lawns. Both cool and warm-season grasses face challenges.',                               lastFrost: { month: 3, day: 25 }, firstFrost: { month: 11, day: 5 }, growingDays: 225 },
        '7a': { temp: '0 to 5¬∞F',     climate: 'Transition Zone',    description: 'Transition zone, cooler half. Cool-season grasses can struggle in summer heat.',                                lastFrost: { month: 3, day: 30 }, firstFrost: { month: 11, day: 1 }, growingDays: 216 },
        '7b': { temp: '5 to 10¬∞F',    climate: 'Transition Zone',    description: 'Transition zone, warmer half. Warm-season grasses become more reliable.',                                       lastFrost: { month: 3, day: 20 }, firstFrost: { month: 11, day: 10 }, growingDays: 235 },
        '8':  { temp: '10 to 20¬∞F',   climate: 'Southern',           description: 'Mild winters, hot summers. Warm-season grasses thrive here.',                                                   lastFrost: { month: 3, day: 8  }, firstFrost: { month: 11, day: 22 }, growingDays: 259 },
        '8a': { temp: '10 to 15¬∞F',   climate: 'Southern',           description: 'Mild winters, hot summers. Warm-season grasses thrive; cool-season overseeding possible.',                     lastFrost: { month: 3, day: 12 }, firstFrost: { month: 11, day: 18 }, growingDays: 251 },
        '8b': { temp: '15 to 20¬∞F',   climate: 'Southern',           description: 'Mild winters, long hot summers. Warm-season grasses dominate.',                                                 lastFrost: { month: 3, day: 3  }, firstFrost: { month: 11, day: 28 }, growingDays: 270 },
        '9':  { temp: '20 to 30¬∞F',   climate: 'Deep South / Gulf',  description: 'Very mild winters, long hot summers. Warm-season grasses dominate.',                                            lastFrost: { month: 2, day: 15 }, firstFrost: { month: 12, day: 10 }, growingDays: 298 },
        '9a': { temp: '20 to 25¬∞F',   climate: 'Deep South / Gulf',  description: 'Very mild winters, long hot summers. Warm-season grasses dominate.',                                            lastFrost: { month: 2, day: 20 }, firstFrost: { month: 12, day: 6  }, growingDays: 289 },
        '9b': { temp: '25 to 30¬∞F',   climate: 'Deep South / Gulf',  description: 'Nearly frost-free, intense heat and humidity. Warm-season grasses only.',                                      lastFrost: { month: 2, day: 8  }, firstFrost: { month: 12, day: 16 }, growingDays: 311 }
    };

    const getParentZone = (zone) => zone ? zone.replace(/[ab]$/i, '') : zone;

    // ‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function LawnCareTracker() {
        const [activities, setActivities] = useState([]);
        const [view, setView] = useState(null);
        const [selectedActivityType, setSelectedActivityType] = useState(null);
        const [weather, setWeather] = useState(null);
        const [weatherLoading, setWeatherLoading] = useState(true);
        const [equipment, setEquipment] = useState([]);
        const [lawnProfile, setLawnProfile] = useState(null);
        const [statsView, setStatsView] = useState('year');
        const [profileFormData, setProfileFormData] = useState(() => {
            const s = localStorage.getItem('lawnProfile');
            return s ? JSON.parse(s) : { lawnSize: '', zone: '', specificGrass: '', soilType: '', zipCode: '' };
        });
        const [profileEditing, setProfileEditing] = useState(() => {
            const s = localStorage.getItem('lawnProfile');
            if (!s) return true;
            const p = JSON.parse(s);
            return !p.specificGrass || !p.zone;
        });
        const [zipLookupLoading, setZipLookupLoading] = useState(false);
        const [zipLookupError, setZipLookupError] = useState('');

        // ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const [currentUser, setCurrentUser] = useState(null);
        const [authReady, setAuthReady] = useState(false);
        const [showAuthModal, setShowAuthModal] = useState(false);
        const [dataLoading, setDataLoading] = useState(true);
        const fb = window.__FIREBASE__ || {};

        // ‚îÄ‚îÄ Data store (wraps localStorage ‚Üî Firestore) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const store = useDataStore(currentUser);

        // ‚îÄ‚îÄ Listen for Firebase auth state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        useEffect(() => {
            if (!fb.configured) {
                setAuthReady(true);
                return;
            }
            const unsub = fb.onAuthStateChanged(fb.auth, (user) => {
                setCurrentUser(user);
                setAuthReady(true);
            });
            return unsub;
        }, []);

        // ‚îÄ‚îÄ Load data whenever auth state settles or user changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        useEffect(() => {
            if (!authReady) return;
            setDataLoading(true);
            store.loadAll().then(({ activities: acts, equipment: eq, profile: prof }) => {
                setActivities(acts || []);
                setEquipment(eq || []);
                if (prof) {
                    setLawnProfile(prof);
                    setProfileFormData(prof);
                    setProfileEditing(!prof.specificGrass || !prof.zone);
                    fetchWeatherData(prof.lat, prof.lon, prof.zipCode);
                } else {
                    fetchWeatherData();
                }
                setDataLoading(false);
            }).catch((e) => {
                console.error('Failed to load data:', e);
                setDataLoading(false);
            });
        }, [authReady, currentUser]);

        const handleSignOut = async () => {
            if (fb.configured) await fb.signOut(fb.auth);
            setCurrentUser(null);
        };

        const WMO_CODES = {
            0: { label: 'Clear Sky', icon: '‚òÄÔ∏è' }, 1: { label: 'Mainly Clear', icon: 'üå§Ô∏è' },
            2: { label: 'Partly Cloudy', icon: '‚õÖ' }, 3: { label: 'Overcast', icon: '‚òÅÔ∏è' },
            45: { label: 'Foggy', icon: 'üå´Ô∏è' }, 48: { label: 'Icy Fog', icon: 'üå´Ô∏è' },
            51: { label: 'Light Drizzle', icon: 'üå¶Ô∏è' }, 53: { label: 'Drizzle', icon: 'üå¶Ô∏è' },
            55: { label: 'Heavy Drizzle', icon: 'üåßÔ∏è' }, 61: { label: 'Light Rain', icon: 'üåßÔ∏è' },
            63: { label: 'Rain', icon: 'üåßÔ∏è' }, 65: { label: 'Heavy Rain', icon: 'üåßÔ∏è' },
            71: { label: 'Light Snow', icon: 'üå®Ô∏è' }, 73: { label: 'Snow', icon: '‚ùÑÔ∏è' },
            75: { label: 'Heavy Snow', icon: '‚ùÑÔ∏è' }, 80: { label: 'Light Showers', icon: 'üå¶Ô∏è' },
            81: { label: 'Showers', icon: 'üåßÔ∏è' }, 82: { label: 'Heavy Showers', icon: '‚õàÔ∏è' },
            95: { label: 'Thunderstorm', icon: '‚õàÔ∏è' }, 99: { label: 'Thunderstorm w/ Hail', icon: '‚õàÔ∏è' }
        };

        const getWindDirection = (deg) => {
            const dirs = ['N','NE','E','SE','S','SW','W','NW'];
            return dirs[Math.round(deg / 45) % 8];
        };

        const fetchWeatherData = async (lat, lon, label) => {
            if (!lat || !lon) {
                const stored = localStorage.getItem('lawnProfile');
                if (stored) {
                    const p = JSON.parse(stored);
                    lat = p.lat; lon = p.lon; label = label || p.zipCode || '';
                }
            }
            if (!lat || !lon) { setWeatherLoading(false); return; }
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                    `&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weathercode,windspeed_10m,winddirection_10m` +
                    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,uv_index_max,et0_fao_evapotranspiration` +
                    `&temperature_unit=fahrenheit&precipitation_unit=inch&windspeed_unit=mph&timezone=auto&past_days=7&forecast_days=14`
                );
                const data = await response.json();
                const airTemp = data.current.temperature_2m;
                const soilTemp = Math.round(airTemp - 7);
                const dailyHighs = data.daily.temperature_2m_max || [];
                const dailyLows = data.daily.temperature_2m_min || [];
                const dailyPrecip = data.daily.precipitation_sum || [];
                const dailyPrecipP = data.daily.precipitation_probability_max || [];
                const dailyET0 = data.daily.et0_fao_evapotranspiration || [];
                const dailyDates = data.daily.time || [];
                let weeklyRainfall = 0;
                for (let i = 0; i <= 6 && i < dailyPrecip.length; i++) weeklyRainfall += (dailyPrecip[i] || 0);
                weeklyRainfall = Math.round(weeklyRainfall * 10) / 10;
                const rainNext24h = Math.round((dailyPrecip[7] || 0) * 100) / 100;
                const rainNext48h = Math.round(((dailyPrecip[7] || 0) + (dailyPrecip[8] || 0)) * 100) / 100;
                const rainNext72h = Math.round(((dailyPrecip[7] || 0) + (dailyPrecip[8] || 0) + (dailyPrecip[9] || 0)) * 100) / 100;
                let frostRiskDays = null;
                for (let i = 7; i < dailyLows.length; i++) {
                    if ((dailyLows[i] ?? 999) <= 32) { frostRiskDays = i - 7; break; }
                }
                const pastHighs = dailyHighs.slice(0, 7);
                const futureHighs = dailyHighs.slice(7, 14);
                const pastAvgSoilTemp = pastHighs.length ? Math.round(pastHighs.reduce((s,v) => s + ((v ?? airTemp) - 7), 0) / pastHighs.length) : soilTemp;
                const futureAvgSoilTemp = futureHighs.length ? Math.round(futureHighs.reduce((s,v) => s + ((v ?? airTemp) - 7), 0) / futureHighs.length) : soilTemp;
                const soilTempDelta = futureAvgSoilTemp - pastAvgSoilTemp;
                const soilTempTrend = soilTempDelta >= 3 ? 'warming' : soilTempDelta <= -3 ? 'cooling' : 'stable';
                const forecastDays = dailyDates.slice(7).map((date, i) => ({
                    date, high: Math.round(dailyHighs[7+i] ?? airTemp),
                    low: Math.round(dailyLows[7+i] ?? airTemp),
                    precip: Math.round((dailyPrecip[7+i] || 0) * 100) / 100,
                    precipProb: dailyPrecipP[7+i] ?? null,
                }));
                const wmoCode = data.current.weathercode;
                const condition = WMO_CODES[wmoCode] || { label: 'Unknown', icon: 'üå°Ô∏è' };
                setWeather({
                    temperature: Math.round(airTemp), feelsLike: Math.round(data.current.apparent_temperature),
                    soilTemp, humidity: data.current.relative_humidity_2m,
                    highTemp: Math.round(dailyHighs[7] ?? airTemp), lowTemp: Math.round(dailyLows[7] ?? airTemp),
                    rainfall: weeklyRainfall, precipitation: Math.round(data.current.precipitation * 100) / 100,
                    precipProbability: dailyPrecipP[7] ?? null,
                    windSpeed: Math.round(data.current.windspeed_10m), windDirection: getWindDirection(data.current.winddirection_10m),
                    uvIndex: data.daily.uv_index_max?.[7] ?? null,
                    conditionLabel: condition.label, conditionIcon: condition.icon,
                    location: label ? `Zip ${label}` : 'Your Location',
                    forecastDays, rainNext24h, rainNext48h, rainNext72h,
                    minTempNext14: Math.min(...dailyLows.slice(7).map(v => v ?? 999)),
                    frostRiskDays, pastAvgSoilTemp, futureAvgSoilTemp, soilTempTrend,
                    et0Past7: Math.round(dailyET0.slice(0, 7).reduce((s, v) => s + (v || 0), 0) * 100) / 100,
                });
                setWeatherLoading(false);
            } catch (error) {
                console.error('Weather fetch error:', error);
                setWeatherLoading(false);
            }
        };

        const getTaskWeatherStatus = (taskText, w) => {
            if (!w) return null;
            const t = taskText.toLowerCase();
            const isSeed = /seed|overseed|\bsod\b|plug/.test(t);
            const isPreEmergent = /pre-emergent|pre emergent|crabgrass prev|prodiamine|dithiopyr/.test(t);
            const isFertilizer = !isPreEmergent && /fertil|\bfeed\b|nitrogen|weed[- ]and[- ]feed|milorganite|scotts/.test(t);
            const isTreatment = !isPreEmergent && !isFertilizer && !isSeed && /herbicide|fungicide|insecticide|pesticide|post-emergent|treatment|\bspray\b|\bapply\b/.test(t);
            const isMowing = /\bmow\b|cut height|blade height|mowing/.test(t);
            const isWatering = /\bwater\b|irrigat|drought/.test(t);
            const isAeration = /aerat|core plug|plug pull/.test(t);
            const frost = w.frostRiskDays;
            const rainNext24 = w.rainNext24h || 0;
            const rainNext48 = w.rainNext48h || 0;
            const rainNext72 = w.rainNext72h || 0;
            const avgSoil = w.pastAvgSoilTemp ?? w.soilTemp;
            const soilTrend = w.soilTempTrend;
            if (isSeed) {
                if (frost !== null && frost <= 21) return { status: 'hold', reason: `Frost risk in ${frost === 0 ? 'next 24h' : frost + ' days'} ‚Äî seedlings won't survive`, window: 'Wait until 21+ frost-free days in forecast' };
                if (rainNext24 > 0.5) return { status: 'hold', reason: `Heavy rain (${rainNext24}") in next 24h ‚Äî seeds wash away`, window: 'Apply after rain passes' };
                if (avgSoil < 50) return { status: 'hold', reason: `Soil avg ${avgSoil}¬∞F is below germination threshold (50¬∞F min)`, window: 'Wait for sustained soil temps above 50¬∞F' };
                return { status: 'go', reason: 'Soil temps and forecast look favorable for seeding', window: null };
            }
            if (isPreEmergent) {
                if (avgSoil >= 55) return { status: 'hold', reason: `Soil avg ${avgSoil}¬∞F ‚Äî pre-emergent window has passed`, window: 'Switch to post-emergent control' };
                if (rainNext48 > 0.75) return { status: 'hold', reason: `Heavy rain (${rainNext48}") in 48h may wash product before it binds`, window: 'Apply after heavy rain event' };
                return { status: 'go', reason: `Soil avg ${avgSoil}¬∞F is in the pre-emergent window`, window: null };
            }
            if (isFertilizer) {
                if (rainNext48 > 0.3) return { status: 'hold', reason: `Rain (${rainNext48}") in next 48h ‚Äî fertilizer leaches before absorption`, window: rainNext72 <= 0.1 ? 'Apply in ~72h' : 'Apply in next dry window' };
                if (avgSoil < 50) return { status: 'hold', reason: `Soil avg ${avgSoil}¬∞F ‚Äî grass not actively growing, can't uptake nutrients`, window: 'Wait for soil temps above 50¬∞F' };
                if (w.highTemp > 90) return { status: 'caution', reason: `High of ${w.highTemp}¬∞F ‚Äî fertilizer can burn heat-stressed turf`, window: null };
                return { status: 'go', reason: 'Dry window ahead and soil temps support active growth', window: null };
            }
            if (isTreatment) {
                if (rainNext24 > 0.1) return { status: 'hold', reason: `Rain expected in next 24h ‚Äî product washes off`, window: 'Apply after rain clears' };
                if (w.windSpeed > 10) return { status: 'hold', reason: `Wind at ${w.windSpeed} mph ‚Äî spray drift risk`, window: 'Apply when wind drops below 10 mph' };
                return { status: 'go', reason: 'Clear, calm conditions ‚Äî good window for treatment', window: null };
            }
            if (isMowing) {
                if (w.precipitation > 0.05 || (w.conditionLabel || '').toLowerCase().includes('rain')) return { status: 'caution', reason: 'Grass is wet ‚Äî mowing wet spreads disease', window: 'Wait until grass dries' };
                return { status: 'go', reason: 'Good conditions for mowing', window: null };
            }
            if (isWatering) {
                const deficit = 1.25 - (w.rainfall || 0) - rainNext48;
                if (deficit <= 0) return { status: 'hold', reason: `Rain covers weekly need ‚Äî skip irrigation`, window: null };
                return { status: 'go', reason: `Deficit ~${Math.round(Math.max(0,deficit)*100)/100}" ‚Äî supplemental irrigation recommended`, window: null };
            }
            return null;
        };

        const lookupZoneByZip = async (zipOverride) => {
            const zip = (zipOverride || profileFormData.zipCode || '').trim();
            if (!/^\d{5}$/.test(zip)) { setZipLookupError('Enter a valid 5-digit US zip code.'); return; }
            setZipLookupError(''); setZipLookupLoading(true);
            try {
                const res = await fetch(`https://phzmapi.org/${zip}.json`);
                if (!res.ok) throw new Error('Not found');
                const data = await res.json();
                const zone = (data.zone || '').toLowerCase().trim();
                if (zone && ZONE_INFO[zone]) {
                    const lat = parseFloat(data.coordinates?.lat);
                    const lon = parseFloat(data.coordinates?.lon);
                    setProfileFormData(prev => ({ ...prev, zone, lat, lon, zipCode: zip }));
                    fetchWeatherData(lat, lon, zip);
                    const existing = localStorage.getItem('lawnProfile');
                    const merged = { ...(existing ? JSON.parse(existing) : {}), zone, lat, lon, zipCode: zip };
                    localStorage.setItem('lawnProfile', JSON.stringify(merged));
                    setLawnProfile(merged);
                } else {
                    setZipLookupError('Zone not found. Please select manually.');
                }
            } catch(e) {
                setZipLookupError('Could not look up zone. Check connection or select manually.');
            } finally { setZipLookupLoading(false); }
        };

        // Activity actions (async, go through store)
        const addActivity = async (activityData) => {
            const newActivity = {
                id: Date.now(),
                type: selectedActivityType,
                date: activityData.date,
                notes: activityData.notes,
                cost: activityData.cost ? parseFloat(activityData.cost) : null,
                data: activityData.data,
                createdAt: new Date().toISOString()
            };
            const saved = await store.saveActivity(newActivity);
            setActivities(prev => [...prev, saved]);
            alert('‚úÖ Activity saved!');
            setView(null);
            setSelectedActivityType(null);
        };

        const deleteActivity = async (id) => {
            if (confirm('Delete this activity?')) {
                await store.deleteActivity(id);
                setActivities(prev => prev.filter(a => a.id !== id));
            }
        };

        const addEquipment = async (equipmentData) => {
            const newItem = { id: Date.now(), ...equipmentData, createdAt: new Date().toISOString() };
            const saved = await store.saveEquipment(newItem);
            setEquipment(prev => [...prev, saved]);
        };

        const deleteEquipment = async (id) => {
            if (confirm('Remove this equipment?')) {
                await store.deleteEquipment(id);
                setEquipment(prev => prev.filter(e => e.id !== id));
            }
        };

        // ‚îÄ‚îÄ Season Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SeasonBanner = () => {
            const month = new Date().getMonth();
            let seasonLabel, seasonDetail, bannerIcon, actionText, gradFrom, gradTo;
            if (weather) {
                const avgSoil = weather.pastAvgSoilTemp ?? weather.soilTemp;
                const trend = weather.soilTempTrend;
                const trendStr = trend === 'warming' ? ' ¬∑ warming' : trend === 'cooling' ? ' ¬∑ cooling' : '';
                const soilStr = `Soil avg ${avgSoil}¬∞F${trendStr}`;
                if (weather.frostRiskDays !== null && weather.frostRiskDays <= 7) {
                    const when = weather.frostRiskDays === 0 ? 'next 24h' : `${weather.frostRiskDays} days`;
                    seasonLabel = 'Frost Alert'; bannerIcon = 'üå°Ô∏è';
                    seasonDetail = `Freezing temps in ${when}`;
                    actionText = '‚Üí Hold seeding & treatments';
                    gradFrom = '#1e3a5f'; gradTo = '#1e4875';
                } else if (avgSoil < 45) {
                    seasonLabel = 'Dormant Season'; bannerIcon = '‚ùÑÔ∏è';
                    seasonDetail = soilStr;
                    actionText = '‚Üí Plan pre-emergent timing';
                    gradFrom = '#1e3a5f'; gradTo = '#1e4875';
                } else if (avgSoil < 55) {
                    seasonLabel = 'Early Spring'; bannerIcon = 'üå§Ô∏è';
                    seasonDetail = soilStr;
                    actionText = trend === 'warming' ? '‚Üí Pre-emergent window opening' : '‚Üí Check pre-emergent timing';
                    gradFrom = '#6d3309'; gradTo = '#8a3f0a';
                } else if (avgSoil <= 70) {
                    seasonLabel = 'Growing Season'; bannerIcon = 'üå±';
                    seasonDetail = soilStr;
                    actionText = '‚Üí Prime time for lawn care';
                    gradFrom = '#1a4f14'; gradTo = '#2d6b20';
                } else if (avgSoil <= 85) {
                    seasonLabel = 'Peak Summer'; bannerIcon = '‚òÄÔ∏è';
                    seasonDetail = soilStr;
                    actionText = '‚Üí Raise mow height';
                    gradFrom = '#7c2d12'; gradTo = '#9a3412';
                } else {
                    seasonLabel = 'Heat Stress'; bannerIcon = 'üî•';
                    seasonDetail = soilStr;
                    actionText = '‚Üí Water deeply';
                    gradFrom = '#7f1d1d'; gradTo = '#991b1b';
                }
            } else if (month >= 10 || month <= 1) {
                seasonLabel = 'Dormant Season'; bannerIcon = '‚ùÑÔ∏è';
                seasonDetail = 'Plan your spring pre-emergent timing';
                actionText = '‚Üí Plan pre-emergent timing';
                gradFrom = '#1e3a5f'; gradTo = '#1e4875';
            } else if (month >= 2 && month <= 4) {
                seasonLabel = 'Spring Season'; bannerIcon = 'üå±';
                seasonDetail = 'Time for pre-emergent and first feeds';
                actionText = '‚Üí Apply first feeds';
                gradFrom = '#1a4f14'; gradTo = '#2d6b20';
            } else if (month >= 5 && month <= 7) {
                seasonLabel = 'Summer Season'; bannerIcon = '‚òÄÔ∏è';
                seasonDetail = 'Focus on watering and mow height';
                actionText = '‚Üí Raise mow height';
                gradFrom = '#7c2d12'; gradTo = '#9a3412';
            } else {
                seasonLabel = 'Fall Season'; bannerIcon = 'üçÇ';
                seasonDetail = 'Best time to overseed and fertilize';
                actionText = '‚Üí Overseed now';
                gradFrom = '#6d3309'; gradTo = '#8a3f0a';
            }
            return (
                <div className="animate-fade-in" style={{background: `linear-gradient(135deg, ${gradFrom} 0%, ${gradTo} 100%)`}}>
                    <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-2.5">
                            <span className="text-xl">{bannerIcon}</span>
                            <div>
                                <div className="text-xs font-bold text-white/60 uppercase tracking-widest">{seasonLabel}</div>
                                <div className="text-xs text-white/80">{seasonDetail}</div>
                            </div>
                        </div>
                        <div className="text-xs font-semibold text-white/90 bg-white/10 border border-white/20 rounded-lg px-2.5 py-1.5 whitespace-nowrap flex-shrink-0 ml-3">
                            {actionText}
                        </div>
                    </div>
                </div>
            );
        };

        const ForecastImpactCard = ({ tasks }) => {
            if (!weather || !tasks || tasks.length === 0) return null;
            const evaluated = tasks.map(task => ({ task, result: getTaskWeatherStatus(task, weather) })).filter(r => r.result !== null);
            const holds = evaluated.filter(e => e.result.status === 'hold');
            const cautions = evaluated.filter(e => e.result.status === 'caution');
            if (holds.length === 0 && cautions.length === 0) {
                return (
                    <div className="bg-[#e8f5e9] border border-[#367C2B] rounded-xl p-4">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="text-base">‚úÖ</span>
                            <span className="text-sm font-bold text-[#367C2B]">Good Week for Lawn Work</span>
                        </div>
                        <div className="text-xs text-gray-600">Forecast conditions are favorable for all recommended tasks this month.</div>
                    </div>
                );
            }
            return (
                <div className="bg-amber-50 border border-amber-300 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-3">
                        <span className="text-base">‚ö†Ô∏è</span>
                        <span className="text-sm font-bold text-gray-800">Weather Timing Alert</span>
                    </div>
                    <div className="space-y-3">
                        {holds.map((h, i) => (
                            <div key={i} className="flex items-start gap-2">
                                <span className="text-xs font-bold text-white bg-red-500 rounded px-1.5 py-0.5 shrink-0 mt-0.5">HOLD</span>
                                <div>
                                    <div className="text-xs font-semibold text-gray-800">{h.task}</div>
                                    <div className="text-xs text-gray-600 mt-0.5">{h.result.reason}</div>
                                    {h.result.window && <div className="text-xs text-[#367C2B] font-medium mt-0.5">‚Üí {h.result.window}</div>}
                                </div>
                            </div>
                        ))}
                        {cautions.map((c, i) => (
                            <div key={i} className="flex items-start gap-2">
                                <span className="text-xs font-bold text-white bg-amber-500 rounded px-1.5 py-0.5 shrink-0 mt-0.5">NOTE</span>
                                <div>
                                    <div className="text-xs font-semibold text-gray-800">{c.task}</div>
                                    <div className="text-xs text-gray-600 mt-0.5">{c.result.reason}</div>
                                    {c.result.window && <div className="text-xs text-[#367C2B] font-medium mt-0.5">‚Üí {c.result.window}</div>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const WaterDeficitCard = ({ grassInfo }) => {
            if (!weather) return null;
            let weeklyNeed = 1.25;
            if (grassInfo && grassInfo.waterPerWeek) {
                const nums = grassInfo.waterPerWeek.match(/[\d.]+/g);
                if (nums && nums.length === 1) weeklyNeed = parseFloat(nums[0]);
                else if (nums && nums.length >= 2) weeklyNeed = (parseFloat(nums[0]) + parseFloat(nums[1])) / 2;
            }
            const pastRain = weather.rainfall || 0;
            const forecastRain = weather.rainNext48h || 0;
            const deficit = Math.max(0, Math.round((weeklyNeed - pastRain - forecastRain) * 100) / 100);
            const surplus = pastRain + forecastRain >= weeklyNeed;
            const statusIcon = surplus ? '‚úÖ' : deficit < 0.5 ? '‚ö†Ô∏è' : 'üíß';
            const statusColor = surplus ? 'text-[#367C2B]' : deficit < 0.5 ? 'text-amber-600' : 'text-blue-700';
            const statusMsg = surplus ? 'Weekly water need covered ‚Äî skip supplemental irrigation'
                : deficit < 0.25 ? `Minor deficit (~${deficit}") ‚Äî monitor and supplement if grass shows stress`
                : `Supplement with ~${deficit}" ‚Äî water early morning for best absorption`;
            return (
                <div className="bg-blue-50 rounded-xl p-4">
                    <div className="text-xs font-bold text-blue-700 uppercase mb-3">üíß Weekly Water Budget</div>
                    <div className="grid grid-cols-3 gap-2 text-center mb-3">
                        <div className="bg-white rounded-lg p-2 shadow-sm"><div className="text-xs text-gray-500 mb-0.5">Weekly need</div><div className="text-sm font-bold text-gray-800">{weeklyNeed}"</div></div>
                        <div className="bg-white rounded-lg p-2 shadow-sm"><div className="text-xs text-gray-500 mb-0.5">Past 7d rain</div><div className="text-sm font-bold text-gray-800">{pastRain}"</div></div>
                        <div className="bg-white rounded-lg p-2 shadow-sm"><div className="text-xs text-gray-500 mb-0.5">Forecast 48h</div><div className="text-sm font-bold text-gray-800">{forecastRain}"</div></div>
                    </div>
                    <div className={`text-xs font-semibold ${statusColor} flex items-center gap-1.5`}>
                        <span>{statusIcon}</span><span>{statusMsg}</span>
                    </div>
                </div>
            );
        };

        const WeatherSnapshot = () => {
            const [zipInput, setZipInput] = useState('');
            if (weatherLoading) {
                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-3 animate-pulse">
                        <div className="h-4 bg-gray-200 rounded w-1/3 mb-3"></div>
                        <div className="h-10 bg-gray-200 rounded w-1/2 mb-2"></div>
                        <div className="h-3 bg-gray-100 rounded w-1/4"></div>
                    </div>
                );
            }
            if (!weather) return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-3">
                    <div className="flex items-center gap-2 mb-3">
                        <div className="text-2xl">üìç</div>
                        <div className="font-semibold text-gray-700 text-sm">Enter your zip code for local weather</div>
                    </div>
                    <div className="flex gap-2">
                        <input type="text" inputMode="numeric" maxLength={5} value={zipInput} onChange={(e) => setZipInput(e.target.value)}
                            onKeyDown={(e) => { if (e.key === 'Enter') lookupZoneByZip(zipInput); }}
                            placeholder="e.g. 43201" className="flex-1 px-3 py-2 border-2 rounded-lg text-sm" />
                        <button type="button" onClick={() => lookupZoneByZip(zipInput)} disabled={zipLookupLoading}
                            className="px-4 py-2 bg-[#367C2B] text-white rounded-lg font-semibold text-sm disabled:opacity-60 whitespace-nowrap">
                            {zipLookupLoading ? 'Looking up...' : 'Get Weather'}
                        </button>
                    </div>
                    {zipLookupError && <div className="mt-1 text-xs text-red-600">{zipLookupError}</div>}
                </div>
            );

            let soilRec = '', soilRecColor = 'text-gray-700', soilAlert = null;
            const _curMon = new Date().getMonth();
            const _grassInfo = lawnProfile && GRASS_INFO[lawnProfile.specificGrass] ? GRASS_INFO[lawnProfile.specificGrass] : null;
            const _isCool = _grassInfo && _grassInfo.season === 'Cool Season';
            const _isWarm = _grassInfo && _grassInfo.season === 'Warm Season';
            const _isSpring = _curMon >= 1 && _curMon <= 5;
            const _isFall   = _curMon >= 7 && _curMon <= 10;
            const _st = weather.soilTemp;
            if (_isCool && _isSpring && _st >= 44 && _st < 50) {
                soilRec = '‚ö†Ô∏è Pre-emergent window approaching'; soilRecColor = 'text-amber-600';
                soilAlert = { level: 'warning', text: `Soil ${_st}¬∞F ‚Äî pre-emergent triggers at 50¬∞F. Apply within the next 1‚Äì2 weeks.` };
            } else if (_isCool && _isSpring && _st >= 50 && _st <= 54) {
                soilRec = 'üö® Pre-emergent window open now'; soilRecColor = 'text-orange-600';
                soilAlert = { level: 'urgent', text: `Soil ${_st}¬∞F ‚Äî apply pre-emergent before it hits 55¬∞F or crabgrass germinates!` };
            } else if (_isCool && _isSpring && _st >= 55 && _st <= 62) {
                soilRec = 'üî¥ Pre-emergent window has closed'; soilRecColor = 'text-red-600';
                soilAlert = { level: 'note', text: `Soil passed 55¬∞F. Switch to post-emergent herbicide for crabgrass control this season.` };
            } else if (_isCool && _isFall && _st >= 50 && _st <= 65) {
                soilRec = '‚úÖ Prime overseeding window'; soilRecColor = 'text-green-700';
                soilAlert = { level: 'go', text: `Soil ${_st}¬∞F ‚Äî ideal for cool-season seed germination. Overseed now for best results.` };
            } else if (_isCool && _isFall && _st > 0 && _st < 50) {
                soilRec = '‚ö†Ô∏è Seeding window is closing'; soilRecColor = 'text-amber-600';
                soilAlert = { level: 'warning', text: `Soil ${_st}¬∞F ‚Äî below 50¬∞F germination threshold. Last call for overseeding this fall.` };
            } else if (_isWarm && _isSpring && _st >= 60 && _st < 65) {
                soilRec = 'üå± Warm-season grass emerging soon'; soilRecColor = 'text-green-700';
                soilAlert = { level: 'go', text: `Soil ${_st}¬∞F ‚Äî green-up is near. Hold fertilizer until soil consistently hits 65¬∞F.` };
            } else if (_isWarm && _isSpring && _st >= 65 && _st <= 75) {
                soilRec = '‚úÖ Green-up zone ‚Äî fertilizer ready'; soilRecColor = 'text-[#367C2B]';
                soilAlert = { level: 'go', text: `Soil ${_st}¬∞F ‚Äî warm-season grass actively growing. Time for first fertilizer application.` };
            } else if (_st < 50) {
                soilRec = '‚ùÑÔ∏è Too cold for most lawn activity'; soilRecColor = 'text-blue-700';
            } else if (_st <= 65) {
                soilRec = 'üå± Good for cool-season grass care'; soilRecColor = 'text-green-700';
            } else if (_st <= 85) {
                soilRec = '‚òÄÔ∏è Ideal growing conditions'; soilRecColor = 'text-[#367C2B]';
            } else {
                soilRec = 'üî• Very warm ‚Äî focus on watering'; soilRecColor = 'text-orange-700';
            }

            const uvLabel = weather.uvIndex !== null
                ? weather.uvIndex <= 2 ? 'Low' : weather.uvIndex <= 5 ? 'Moderate' : weather.uvIndex <= 7 ? 'High' : 'Very High' : null;

            return (
                <div className="animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="bg-gradient-to-r from-[#367C2B] to-[#4a9c3a] px-4 pt-4 pb-3">
                            <div className="flex items-start justify-between">
                                <div>
                                    <div className="text-xs font-semibold text-green-200 uppercase tracking-widest mb-1">{weather.location} ¬∑ Live</div>
                                    <div className="flex items-end gap-2">
                                        <span className="text-5xl font-black text-white leading-none">{weather.temperature}¬∞</span>
                                        <div className="pb-1.5">
                                            <div className="text-sm font-semibold text-green-100">Feels like {weather.feelsLike}¬∞</div>
                                            <div className="text-xs text-green-200">H: {weather.highTemp}¬∞ ¬∑ L: {weather.lowTemp}¬∞</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-4xl">{weather.conditionIcon}</div>
                                    <div className="text-xs font-semibold text-green-100 mt-1.5 bg-white/10 rounded-lg px-2 py-0.5">{weather.conditionLabel}</div>
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-4 gap-1.5 p-1.5 bg-gray-50">
                            <div className="text-center py-2 px-1 bg-white rounded-xl shadow-sm">
                                <div className="text-xs text-gray-400 mb-0.5">Humidity</div>
                                <div className="text-sm font-bold text-gray-800">{weather.humidity}%</div>
                            </div>
                            <div className="text-center py-2 px-1 bg-white rounded-xl shadow-sm">
                                <div className="text-xs text-gray-400 mb-0.5">Wind</div>
                                <div className="text-sm font-bold text-gray-800">{weather.windSpeed} mph</div>
                            </div>
                            <div className="text-center py-2 px-1 bg-white rounded-xl shadow-sm">
                                <div className="text-xs text-gray-400 mb-0.5">7-Day Rain</div>
                                <div className="text-sm font-bold text-gray-800">{weather.rainfall}"</div>
                            </div>
                            <div className="text-center py-2 px-1 bg-white rounded-xl shadow-sm">
                                {weather.precipProbability !== null
                                    ? <><div className="text-xs text-gray-400 mb-0.5">Rain %</div><div className="text-sm font-bold text-gray-800">{weather.precipProbability}%</div></>
                                    : uvLabel ? <><div className="text-xs text-gray-400 mb-0.5">UV</div><div className="text-sm font-bold text-gray-800">{weather.uvIndex} {uvLabel}</div></>
                                    : <><div className="text-xs text-gray-400 mb-0.5">UV</div><div className="text-sm font-bold text-gray-800">‚Äî</div></>}
                            </div>
                        </div>
                        <div className="border-t border-gray-100 flex items-center divide-x divide-gray-100">
                            <div className="flex-1 px-4 py-3">
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-0.5">Soil Temp</div>
                                <div className="flex items-baseline gap-1.5">
                                    <span className="text-xl font-extrabold text-amber-600">{weather.soilTemp}¬∞F</span>
                                    <span className="text-xs text-gray-400">est. 4" depth</span>
                                </div>
                            </div>
                            <div className="flex-1 px-4 py-3">
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-0.5">Status</div>
                                <div className={`text-xs font-bold ${soilRecColor}`}>{soilRec}</div>
                            </div>
                        </div>
                        {soilAlert && (
                            <div className={`px-4 py-2.5 border-t flex items-start gap-2 ${
                                soilAlert.level === 'urgent'  ? 'bg-orange-50 border-orange-100' :
                                soilAlert.level === 'warning' ? 'bg-amber-50 border-amber-100'   :
                                soilAlert.level === 'go'      ? 'bg-green-50 border-green-100'   :
                                'bg-gray-50 border-gray-100'
                            }`}>
                                <div className={`text-xs font-semibold leading-snug ${
                                    soilAlert.level === 'urgent'  ? 'text-orange-700' :
                                    soilAlert.level === 'warning' ? 'text-amber-700'  :
                                    soilAlert.level === 'go'      ? 'text-green-700'  :
                                    'text-gray-600'
                                }`}>{soilAlert.text}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ActivitySelector = () => (
            <div className="animate-fade-in">
                <h2 className="text-xl font-bold mb-4">Select Activity Type</h2>
                <div className="grid grid-cols-2 gap-3">
                    {Object.entries(ACTIVITY_TYPES).map(([key, type]) => {
                        const colors = ACTIVITY_COLORS[key] || ACTIVITY_COLORS.mowing;
                        return (
                            <button key={key} onClick={() => setSelectedActivityType(key)}
                                className={`${colors.bg} border-2 p-4 rounded-xl shadow-md card-hover btn-press`}
                                style={{borderColor: colors.hex + '4D'}}
                                onMouseEnter={(e) => e.currentTarget.style.borderColor = colors.hex}
                                onMouseLeave={(e) => e.currentTarget.style.borderColor = colors.hex + '4D'}>
                                <div className="text-4xl mb-2">{type.icon}</div>
                                <div className={`text-sm font-bold ${colors.text}`}>{type.name}</div>
                            </button>
                        );
                    })}
                </div>
                <button onClick={() => setView(null)} className="mt-4 px-4 py-2 bg-gray-200 rounded-lg btn-press">Cancel</button>
            </div>
        );

        const ActivityForm = () => {
            const activityType = ACTIVITY_TYPES[selectedActivityType];
            const [localFormData, setLocalFormData] = useState({ date: new Date().toISOString().split('T')[0], notes: '', data: {} });
            return (
                <div>
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-3">
                        <span className="text-4xl">{activityType.icon}</span>{activityType.name}
                    </h2>
                    <form onSubmit={(e) => { e.preventDefault(); addActivity(localFormData); }} className="bg-white rounded-lg shadow-lg p-6">
                        <div className="mb-4">
                            <label className="block text-sm font-semibold mb-2">Date</label>
                            <input type="date" required value={localFormData.date}
                                onChange={(e) => setLocalFormData({...localFormData, date: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        {activityType.fields.map(field => (
                            <div key={field.name} className="mb-4">
                                <label className="block text-sm font-semibold mb-2">{field.label}{field.required && <span className="text-red-600 ml-1">*</span>}</label>
                                {field.type === 'treatment-category' ? (
                                    <div className="grid grid-cols-2 gap-3">
                                        {Object.entries(TREATMENT_CATEGORIES).map(([key, cat]) => (
                                            <button key={key} type="button"
                                                onClick={() => setLocalFormData({...localFormData, data: {...localFormData.data, category: key, product: ''}})}
                                                className={`p-3 rounded-lg border-2 ${localFormData.data.category === key ? 'bg-[#367C2B] text-white' : 'bg-white'}`}>
                                                <div className="text-xl">{cat.icon}</div>
                                                <div className="text-sm">{cat.label}</div>
                                            </button>
                                        ))}
                                    </div>
                                ) : field.type === 'treatment-product' ? (
                                    localFormData.data.category ? (
                                        <div>
                                            <select onChange={(e) => setLocalFormData({...localFormData, data: {...localFormData.data, product: e.target.value}})}
                                                className="w-full px-4 py-2 border rounded-lg" required={field.required}>
                                                <option value="">Select...</option>
                                                {(TREATMENT_PRODUCTS[localFormData.data.category] || []).map(p => (
                                                    <option key={p.id} value={p.name}>{p.name}</option>
                                                ))}
                                            </select>
                                            {(() => {
                                                const sp = (TREATMENT_PRODUCTS[localFormData.data.category] || []).find(p => p.name === localFormData.data.product);
                                                if (!sp || sp.id.includes('5')) return null;
                                                return (
                                                    <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                        <div className="text-xs font-bold text-blue-800 uppercase mb-2">Product Details</div>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            {sp.activeIngredient && <div><div className="text-xs text-gray-500">Active Ingredient</div><div className="text-xs font-semibold text-gray-800">{sp.activeIngredient}</div></div>}
                                                            {sp.rate && <div><div className="text-xs text-gray-500">Application Rate</div><div className="text-xs font-semibold text-gray-800">{sp.rate}</div></div>}
                                                            {sp.timing && <div><div className="text-xs text-gray-500">Timing</div><div className="text-xs font-semibold text-gray-800">{sp.timing}</div></div>}
                                                            {sp.target && <div><div className="text-xs text-gray-500">Target</div><div className="text-xs font-semibold text-gray-800">{sp.target}</div></div>}
                                                        </div>
                                                        {sp.notes && <div className="mt-2 text-xs text-gray-600 italic">{sp.notes}</div>}
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    ) : <div className="p-4 bg-yellow-50 border rounded">Select category first</div>
                                ) : field.type === 'product-select' ? (() => {
                                    let products = PRODUCT_DATABASE[field.productType] || [];
                                    if (field.filterBy && localFormData.data[field.filterBy]) {
                                        const filterVal = localFormData.data[field.filterBy];
                                        products = products.filter(p => p[field.filterProp] === filterVal || p.id.includes('-other'));
                                    }
                                    return (
                                        <select onChange={(e) => setLocalFormData({...localFormData, data: {...localFormData.data, [field.name]: e.target.value}})}
                                            className="w-full px-4 py-2 border rounded-lg">
                                            <option value="">Select...</option>
                                            {products.map(p => <option key={p.id} value={p.name}>{p.brand} - {p.name} {p.deck ? `(${p.deck})` : ''}</option>)}
                                        </select>
                                    );
                                })()
                                : field.type === 'select' ? (
                                    <select onChange={(e) => setLocalFormData({...localFormData, data: {...localFormData.data, [field.name]: e.target.value}})}
                                        className="w-full px-4 py-2 border rounded-lg">
                                        <option value="">Select...</option>
                                        {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                ) : (
                                    <input type={field.type} placeholder={field.placeholder}
                                        value={localFormData.data[field.name] || ''}
                                        onChange={(e) => setLocalFormData({...localFormData, data: {...localFormData.data, [field.name]: e.target.value}})}
                                        className="w-full px-4 py-2 border rounded-lg" />
                                )}
                            </div>
                        ))}
                        <div className="mb-4">
                            <label className="block text-sm font-semibold mb-2">Notes (Optional)</label>
                            <textarea value={localFormData.notes} onChange={(e) => setLocalFormData({...localFormData, notes: e.target.value})} rows="3" className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        {/* PREMIUM_FEATURE: cost tracking ‚Äî available to all users now; gated to premium subscribers in a future release */}
                        <div className="mb-4">
                            <label className="block text-sm font-semibold mb-2">Cost <span className="text-xs font-normal text-gray-400">(Optional ‚Äî track product &amp; service spend)</span></label>
                            <div className="relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-semibold">$</span>
                                <input type="number" min="0" step="0.01" placeholder="0.00"
                                    value={localFormData.cost || ''}
                                    onChange={(e) => setLocalFormData({...localFormData, cost: e.target.value})}
                                    className="w-full pl-7 pr-4 py-2 border rounded-lg" />
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <button type="submit" className="flex-1 px-6 py-3 bg-[#367C2B] text-white rounded-lg font-semibold">Save Activity</button>
                            <button type="button" onClick={() => { setSelectedActivityType(null); setView(null); }} className="px-6 py-3 bg-gray-200 rounded-lg">Cancel</button>
                        </div>
                    </form>
                </div>
            );
        };

        const ActivityDetails = ({ activity }) => {
            const activityType = ACTIVITY_TYPES[activity.type];
            if (!activityType || !activity.data) return null;
            const fields = activityType.fields || [];
            const details = fields.filter(f => activity.data[f.name]).map(f => {
                let value = activity.data[f.name];
                if (f.name === 'category' && TREATMENT_CATEGORIES[value]) value = TREATMENT_CATEGORIES[value].icon + ' ' + TREATMENT_CATEGORIES[value].label;
                return { label: f.label, value };
            });
            if (details.length === 0 && !activity.notes) return null;
            return (
                <div className="mt-3 pt-3 border-t border-gray-200">
                    {details.length > 0 && (
                        <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                            {details.map(d => (
                                <div key={d.label}>
                                    <div className="text-xs text-gray-500 uppercase tracking-wide">{d.label}</div>
                                    <div className="text-sm font-medium text-gray-800">{d.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                    {activity.cost > 0 && (
                        <div className="mt-2 flex items-center gap-1.5">
                            <div className="text-xs text-gray-500 uppercase tracking-wide">Cost</div>
                            <div className="text-sm font-semibold text-gray-800">${activity.cost.toFixed(2)}</div>
                        </div>
                    )}
                    {activity.notes && (
                        <div className="mt-2">
                            <div className="text-xs text-gray-500 uppercase tracking-wide">Notes</div>
                            <div className="text-sm text-gray-700">{activity.notes}</div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = () => {
            const sorted = [...activities].sort((a, b) => new Date(b.date) - new Date(a.date));
            const [expandedId, setExpandedId] = useState(null);
            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6">Activity History</h2>
                    {sorted.length === 0 ? (
                        <div className="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">No activities yet</div>
                    ) : (
                        <div className="space-y-3">
                            {sorted.map(activity => {
                                const colors = ACTIVITY_COLORS[activity.type] || ACTIVITY_COLORS.mowing;
                                return (
                                    <div key={activity.id} className={`bg-white rounded-xl shadow-md p-4 cursor-pointer card-hover border-l-4 ${colors.border}`} onClick={() => setExpandedId(expandedId === activity.id ? null : activity.id)}>
                                        <div className="flex justify-between items-center">
                                            <div className="flex gap-3 items-center">
                                                <div className="text-3xl">{ACTIVITY_TYPES[activity.type].icon}</div>
                                                <div>
                                                    <h3 className={`text-lg font-bold ${colors.text}`}>{ACTIVITY_TYPES[activity.type].name}</h3>
                                                    <p className="text-sm text-gray-500">{new Date(activity.date).toLocaleDateString()}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-gray-400 text-sm">{expandedId === activity.id ? '‚ñ≤' : '‚ñº'}</span>
                                                <button onClick={(e) => { e.stopPropagation(); deleteActivity(activity.id); }} className="text-red-500 hover:text-red-700 btn-press text-sm">Delete</button>
                                            </div>
                                        </div>
                                        {expandedId === activity.id && <ActivityDetails activity={activity} />}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const MyGarage = () => {
            const [garageForm, setGarageForm] = useState({ name: '', type: 'mowers', selectedProduct: '', customName: '', mowerType: '' });
            const allProducts = PRODUCT_DATABASE[garageForm.type] || [];
            const currentProducts = (garageForm.type === 'mowers' && garageForm.mowerType)
                ? allProducts.filter(p => p.mowerCategory === garageForm.mowerType || p.id.includes('-other'))
                : allProducts;
            const selectedProductData = currentProducts.find(p => p.id === garageForm.selectedProduct);
            const handleTypeChange = (newType) => setGarageForm({ name: '', type: newType, selectedProduct: '', customName: '', mowerType: '' });
            const handleProductSelect = (productId) => {
                const product = currentProducts.find(p => p.id === productId);
                if (product && !product.id.includes('-other')) setGarageForm({ ...garageForm, selectedProduct: productId, name: product.name, customName: '' });
                else setGarageForm({ ...garageForm, selectedProduct: productId, name: '', customName: '' });
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                const finalName = garageForm.selectedProduct && !garageForm.selectedProduct.includes('-other') ? garageForm.name : garageForm.customName;
                if (finalName) {
                    const productInfo = selectedProductData || {};
                    addEquipment({ name: finalName, type: garageForm.type, brand: productInfo.brand || 'Custom', details: productInfo.features || productInfo.type || '', deck: productInfo.deck || '', maintenanceSchedule: productInfo.maintenanceSchedule || null });
                    setGarageForm({ name: '', type: garageForm.type, selectedProduct: '', customName: '' });
                }
            };
            const typeLabels = { mowers: 'Mower', spreaders: 'Spreader', trimmers: 'Trimmer' };
            return (
                <div>
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold">üè† My Garage</h2>
                        <button onClick={() => setView('products')} className="px-3 py-1 text-xs font-semibold text-[#367C2B] border border-[#367C2B] rounded-lg hover:bg-[#367C2B]/10">üìñ Product Guide</button>
                    </div>
                    <div className="bg-white rounded-lg shadow-md p-4 mb-4">
                        <h3 className="font-bold mb-4">Add Equipment</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-semibold mb-2">Equipment Type</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {Object.entries(typeLabels).map(([key, label]) => (
                                        <button key={key} type="button" onClick={() => handleTypeChange(key)}
                                            className={`p-3 rounded-lg text-center transition btn-press ${garageForm.type === key ? 'bg-[#367C2B]/10 text-[#367C2B] border-2 border-[#367C2B]' : 'bg-white text-gray-700 border-2 border-gray-200 hover:border-[#367C2B]'}`}>
                                            <div className="text-xs font-semibold mt-1">{label}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            {garageForm.type === 'mowers' && (
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold mb-2">Mower Type</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['Walk Behind', 'Riding', 'Zero Turn'].map(mt => (
                                            <button key={mt} type="button"
                                                onClick={() => setGarageForm({ ...garageForm, mowerType: mt, selectedProduct: '', name: '', customName: '' })}
                                                className={`p-2 rounded-lg border-2 text-center text-sm font-semibold transition ${garageForm.mowerType === mt ? 'bg-[#367C2B] text-white border-[#367C2B]' : 'bg-white text-gray-700 border-gray-200 hover:border-[#367C2B]'}`}>
                                                {mt}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div className="mb-4">
                                <label className="block text-sm font-semibold mb-2">Select {typeLabels[garageForm.type]}</label>
                                <select value={garageForm.selectedProduct} onChange={(e) => handleProductSelect(e.target.value)} className="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Choose from {currentProducts.length} models...</option>
                                    {currentProducts.map(p => <option key={p.id} value={p.id}>{p.brand} - {p.name} {p.deck ? `(${p.deck})` : ''} {p.type ? `- ${p.type}` : ''}</option>)}
                                </select>
                            </div>
                            {garageForm.selectedProduct && garageForm.selectedProduct.includes('-other') && (
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold mb-2">Custom Name</label>
                                    <input type="text" value={garageForm.customName} onChange={(e) => setGarageForm({...garageForm, customName: e.target.value})} placeholder="Enter your equipment name" className="w-full px-4 py-2 border rounded-lg" />
                                </div>
                            )}
                            {selectedProductData && !garageForm.selectedProduct.includes('-other') && (
                                <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <div className="text-sm font-semibold text-[#367C2B]">{selectedProductData.brand} {selectedProductData.name}</div>
                                    {selectedProductData.features && <div className="text-xs text-gray-600 mt-1">{selectedProductData.features}</div>}
                                    {selectedProductData.maintenanceSchedule && selectedProductData.maintenanceSchedule.note && <div className="text-xs text-gray-500 mt-1 italic">{selectedProductData.maintenanceSchedule.note}</div>}
                                </div>
                            )}
                            <button type="submit" disabled={!garageForm.selectedProduct || (garageForm.selectedProduct.includes('-other') && !garageForm.customName)}
                                className="w-full px-4 py-2 bg-[#367C2B] text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                Add to Garage
                            </button>
                        </form>
                    </div>
                    <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-bold mb-4">Your Equipment ({equipment.length})</h3>
                        {equipment.length === 0 ? (
                            <p className="text-gray-500 text-center py-6">No equipment yet ‚Äî add your first piece above!</p>
                        ) : (
                            <div className="space-y-3">
                                {equipment.map(item => {
                                    const mowingHours = item.type === 'mowers'
                                        ? activities.filter(a => a.type === 'mowing' && a.data && a.data.mowerUsed === item.name).reduce((sum, a) => sum + (parseFloat(a.data.duration) || 45) / 60, 0)
                                        : 0;
                                    const schedule = item.maintenanceSchedule;
                                    return (
                                        <div key={item.id} className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <div className="font-bold">{item.name}</div>
                                                    {item.brand && item.brand !== 'Custom' && <div className="text-sm text-[#367C2B] font-semibold">{item.brand}</div>}
                                                    <div className="text-xs text-gray-500 capitalize">{typeLabels[item.type] || item.type}</div>
                                                    {item.details && <div className="text-xs text-gray-500 mt-1">{item.details}</div>}
                                                </div>
                                                <button onClick={() => deleteEquipment(item.id)} className="px-3 py-1 bg-red-100 text-red-700 rounded text-sm">Remove</button>
                                            </div>
                                            {schedule && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <div className="text-xs font-bold text-[#367C2B] uppercase mb-2">Maintenance Schedule</div>
                                                    {schedule.note ? (
                                                        <div className="text-xs text-gray-500 italic">{schedule.note}</div>
                                                    ) : (
                                                        <div className="space-y-1">
                                                            {item.type === 'mowers' && <div className="text-xs text-gray-600 mb-2">Est. hours logged: <span className="font-bold text-[#367C2B]">{Math.round(mowingHours * 10) / 10} hrs</span></div>}
                                                            <div className="grid grid-cols-2 gap-2">
                                                                {schedule.oilChange && <div className={`text-xs p-2 rounded ${mowingHours >= schedule.oilChange ? 'bg-red-50 border border-red-200' : 'bg-gray-100'}`}><span className="font-semibold">Oil:</span> Every {schedule.oilChange} hrs{mowingHours >= schedule.oilChange && <div className="text-red-600 font-bold mt-0.5">Due now</div>}</div>}
                                                                {schedule.airFilter && <div className={`text-xs p-2 rounded ${typeof schedule.airFilter === 'number' && mowingHours >= schedule.airFilter ? 'bg-red-50 border border-red-200' : 'bg-gray-100'}`}><span className="font-semibold">Air Filter:</span> {typeof schedule.airFilter === 'number' ? `Every ${schedule.airFilter} hrs` : schedule.airFilter}</div>}
                                                                {schedule.sparkPlug && <div className={`text-xs p-2 rounded ${typeof schedule.sparkPlug === 'number' && mowingHours >= schedule.sparkPlug ? 'bg-red-50 border border-red-200' : 'bg-gray-100'}`}><span className="font-semibold">Spark Plug:</span> {typeof schedule.sparkPlug === 'number' ? `Every ${schedule.sparkPlug} hrs` : schedule.sparkPlug}</div>}
                                                                {schedule.cleaning && <div className="text-xs p-2 rounded bg-gray-100"><span className="font-semibold">Cleaning:</span> {schedule.cleaning}</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LawnProfile = () => {
            const [localForm, setLocalForm] = useState({...profileFormData});
            const save = async () => {
                const toSave = {...localForm};
                await store.saveProfile(toSave);
                setLawnProfile(toSave);
                setProfileFormData(toSave);
                setProfileEditing(false);
            };
            const grassInfo = GRASS_INFO[localForm.specificGrass];
            const zoneInfo = ZONE_INFO[localForm.zone];

            const getCurrentMonthTasks = () => {
                if (!localForm.specificGrass || !localForm.zone) return null;
                const keyMap = { 'tall-fescue': 'tallFescue', 'kentucky-bluegrass': 'kentuckyBluegrass', 'perennial-ryegrass': 'perennialRyegrass', 'bermuda': 'bermuda', 'zoysia': 'zoysia', 'st-augustine': 'stAugustine' };
                const programKey = keyMap[localForm.specificGrass] + '_zone' + getParentZone(localForm.zone);
                const program = typeof grassPrograms !== 'undefined' ? grassPrograms[programKey] : null;
                if (!program || !program.schedule) return null;
                const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                const currentMonth = months[new Date().getMonth()];
                return program.schedule.find(s => {
                    if (s.month === currentMonth) return true;
                    if (s.month && s.month.includes('-')) {
                        const parts = s.month.split('-');
                        const startIdx = months.indexOf(parts[0]), endIdx = months.indexOf(parts[1]), curIdx = months.indexOf(currentMonth);
                        if (startIdx >= 0 && endIdx >= 0 && curIdx >= startIdx && curIdx <= endIdx) return true;
                    }
                    return false;
                });
            };
            const currentTasks = getCurrentMonthTasks();

            if (profileEditing) {
                return (
                    <div>
                        <h2 className="text-2xl font-bold mb-6">üå± Lawn Profile</h2>
                        <div className="bg-white rounded-lg shadow p-4 space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Lawn Size (sq ft)</label>
                                <input type="number" value={localForm.lawnSize} onChange={(e) => setLocalForm({...localForm, lawnSize: e.target.value})} placeholder="5000" className="w-full px-4 py-3 border-2 rounded-lg" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2">Find Zone by Zip Code</label>
                                <div className="flex gap-2">
                                    <input type="text" inputMode="numeric" maxLength={5} value={localForm.zipCode || ''} onChange={(e) => setLocalForm({...localForm, zipCode: e.target.value})}
                                        onKeyDown={(e) => { if (e.key === 'Enter') lookupZoneByZip(localForm.zipCode); }} placeholder="e.g. 43201" className="flex-1 px-4 py-3 border-2 rounded-lg" />
                                    <button type="button" onClick={() => lookupZoneByZip(localForm.zipCode)} disabled={zipLookupLoading}
                                        className="px-4 py-3 bg-[#367C2B] text-white rounded-lg font-semibold text-sm disabled:opacity-60 whitespace-nowrap">
                                        {zipLookupLoading ? 'Looking up...' : 'Look Up'}
                                    </button>
                                </div>
                                {zipLookupError && <div className="mt-1 text-xs text-red-600">{zipLookupError}</div>}
                                {localForm.zone && ZONE_INFO[localForm.zone] && !zipLookupError && <div className="mt-1 text-xs text-[#367C2B] font-medium">Zone {localForm.zone.toUpperCase()} detected ‚Äî {ZONE_INFO[localForm.zone].temp}</div>}
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2">USDA Climate Zone <span className="font-normal text-gray-500">(or select manually)</span></label>
                                <select value={localForm.zone} onChange={(e) => setLocalForm({...localForm, zone: e.target.value})} className="w-full px-4 py-3 border-2 rounded-lg">
                                    <option value="">Select...</option>
                                    <optgroup label="Zone 4 ‚Äî Northern Cold (-30 to -20¬∞F)"><option value="4a">Zone 4a (-30 to -25¬∞F)</option><option value="4b">Zone 4b (-25 to -20¬∞F)</option></optgroup>
                                    <optgroup label="Zone 5 ‚Äî Northern (-20 to -10¬∞F)"><option value="5a">Zone 5a (-20 to -15¬∞F)</option><option value="5b">Zone 5b (-15 to -10¬∞F)</option></optgroup>
                                    <optgroup label="Zone 6 ‚Äî Moderate (-10 to 0¬∞F)"><option value="6a">Zone 6a (-10 to -5¬∞F)</option><option value="6b">Zone 6b (-5 to 0¬∞F)</option></optgroup>
                                    <optgroup label="Zone 7 ‚Äî Transition Zone (0 to 10¬∞F)"><option value="7a">Zone 7a (0 to 5¬∞F)</option><option value="7b">Zone 7b (5 to 10¬∞F)</option></optgroup>
                                    <optgroup label="Zone 8 ‚Äî Southern (10 to 20¬∞F)"><option value="8a">Zone 8a (10 to 15¬∞F)</option><option value="8b">Zone 8b (15 to 20¬∞F)</option></optgroup>
                                    <optgroup label="Zone 9 ‚Äî Deep South / Gulf (20 to 30¬∞F)"><option value="9a">Zone 9a (20 to 25¬∞F)</option><option value="9b">Zone 9b (25 to 30¬∞F)</option></optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2">Grass Type</label>
                                <select value={localForm.specificGrass} onChange={(e) => setLocalForm({...localForm, specificGrass: e.target.value})} className="w-full px-4 py-3 border-2 rounded-lg">
                                    <option value="">Select...</option>
                                    <optgroup label="Cool Season"><option value="tall-fescue">Tall Fescue</option><option value="kentucky-bluegrass">Kentucky Bluegrass</option><option value="perennial-ryegrass">Perennial Ryegrass</option></optgroup>
                                    <optgroup label="Warm Season"><option value="bermuda">Bermudagrass</option><option value="zoysia">Zoysia</option><option value="st-augustine">St. Augustine</option></optgroup>
                                </select>
                            </div>
                            <button onClick={save} className="w-full py-4 bg-[#367C2B] text-white rounded-xl font-bold text-lg">üíæ Save Profile</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between mb-2">
                        <h2 className="text-2xl font-bold">üå± My Yard</h2>
                        <button onClick={() => setProfileEditing(true)} className="px-4 py-2 text-sm font-semibold text-[#367C2B] border-2 border-[#367C2B] rounded-lg hover:bg-[#367C2B]/10">Edit Profile</button>
                    </div>
                    <div className="bg-gradient-to-r from-[#367C2B] to-[#4a9c3a] rounded-xl p-5 text-white shadow-lg">
                        <div className="text-lg font-bold">{grassInfo ? grassInfo.name : localForm.specificGrass}</div>
                        <div className="text-sm opacity-90 mt-1">
                            {grassInfo && <span>{grassInfo.season}</span>}
                            {zoneInfo && <span> ¬∑ Zone {localForm.zone} ({zoneInfo.climate}) <CitationBadge sources={[{ name: 'USDA Plant Hardiness Zone Map', url: 'https://planthardiness.ars.usda.gov/', topic: 'Official zone classifications' }]} label="USDA Zone" /></span>}
                            {localForm.lawnSize && <span> ¬∑ {Number(localForm.lawnSize).toLocaleString()} sq ft</span>}
                        </div>
                        {grassInfo && <div className="mt-3 text-sm opacity-90 italic">"{grassInfo.bestFeature}"</div>}
                    </div>
                    {(() => {
                        const zoneNote = grassInfo && grassInfo.zoneNotes && (grassInfo.zoneNotes[localForm.zone] || grassInfo.zoneNotes[getParentZone(localForm.zone)]);
                        if (!zoneNote) return null;
                        const noteLower = zoneNote.toLowerCase();
                        const colorClass = noteLower.includes('not recommended') || noteLower.includes('not viable') ? 'bg-red-50 border-red-500' : noteLower.includes('challenging') || noteLower.includes('difficult') || noteLower.includes('marginal') ? 'bg-yellow-50 border-yellow-500' : 'bg-[#e8f5e9] border-[#367C2B]';
                        return (
                            <div className={`rounded-xl p-4 border-l-4 ${colorClass}`}>
                                <div className="font-bold text-sm mb-1">Zone {localForm.zone} Compatibility <CitationBadge sources={grassInfo.sources} label="Zone adaptation" /></div>
                                <div className="text-sm text-gray-700">{zoneNote}</div>
                            </div>
                        );
                    })()}
                    {grassInfo && (
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-sm font-bold text-[#367C2B] uppercase mb-3">Quick Reference <CitationBadge sources={grassInfo.sources} label="Grass care specs" /></h3>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-gray-50 rounded-lg p-3 text-center"><div className="text-xs text-gray-500 mb-1">Mow Height</div><div className="text-sm font-bold text-gray-800">{grassInfo.mowHeight}</div><div className="text-xs text-gray-400 mt-1">Summer: {grassInfo.mowHeightSummer}</div></div>
                                <div className="bg-gray-50 rounded-lg p-3 text-center"><div className="text-xs text-gray-500 mb-1">Water / Week</div><div className="text-sm font-bold text-gray-800">{grassInfo.waterPerWeek}</div></div>
                                <div className="bg-gray-50 rounded-lg p-3 text-center"><div className="text-xs text-gray-500 mb-1">Sun Needs</div><div className="text-sm font-bold text-gray-800">{grassInfo.sunNeeds}</div></div>
                                <div className="bg-gray-50 rounded-lg p-3 text-center"><div className="text-xs text-gray-500 mb-1">Fertilizer / Year</div><div className="text-sm font-bold text-gray-800">{grassInfo.fertPerYear}</div></div>
                                <div className="bg-gray-50 rounded-lg p-3 text-center"><div className="text-xs text-gray-500 mb-1">Ideal Soil pH</div><div className="text-sm font-bold text-gray-800">{grassInfo.idealSoilPH}</div></div>
                                <div className="bg-gray-50 rounded-lg p-3 text-center"><div className="text-xs text-gray-500 mb-1">Peak Growth</div><div className="text-sm font-bold text-gray-800">{grassInfo.peakGrowth}</div></div>
                                {grassInfo.idealSoilTemp && <div className="bg-gray-50 rounded-lg p-3 text-center col-span-2"><div className="text-xs text-gray-500 mb-1">Ideal Soil Temp</div><div className="text-sm font-bold text-gray-800">{grassInfo.idealSoilTemp}</div></div>}
                            </div>
                            <div className="mt-3 p-3 bg-blue-50 rounded-lg"><div className="text-xs text-blue-600 font-semibold mb-1">Dormancy</div><div className="text-sm text-gray-700">{grassInfo.dormancy}</div></div>
                        </div>
                    )}
                    {currentTasks && weather && <ForecastImpactCard tasks={currentTasks.tasks} />}
                    {currentTasks && (
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-sm font-bold text-[#367C2B] uppercase mb-1">This Month's Tasks <CitationBadge sources={grassInfo ? grassInfo.sources : null} label="Monthly program" /></h3>
                            <div className="text-xs text-gray-500 mb-3">{currentTasks.month}{currentTasks.importance ? ` ‚Äî ${currentTasks.importance}` : ''}</div>
                            <ul className="space-y-3">
                                {currentTasks.tasks.map((task, i) => {
                                    const ws = getTaskWeatherStatus(task, weather);
                                    const badgeStyle = ws ? ws.status === 'go' ? 'bg-[#e8f5e9] text-[#367C2B]' : ws.status === 'caution' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700' : null;
                                    const badgeLabel = ws ? ws.status === 'go' ? '‚úì Good timing' : ws.status === 'caution' ? '‚ö† Note' : '‚úï Hold' : null;
                                    return (
                                        <li key={i} className="flex items-start gap-2 text-sm text-gray-700">
                                            <span className="text-[#367C2B] mt-0.5 font-bold shrink-0">¬∑</span>
                                            <div className="flex-1"><span>{task}</span>{ws && <span className={`ml-2 text-xs font-semibold px-1.5 py-0.5 rounded ${badgeStyle}`}>{badgeLabel}</span>}</div>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )}
                    {grassInfo && weather && <WaterDeficitCard grassInfo={grassInfo} />}
                    {(() => {
                        if (!localForm.specificGrass || !localForm.zone) return null;
                        const keyMap = { 'tall-fescue': 'tallFescue', 'kentucky-bluegrass': 'kentuckyBluegrass', 'perennial-ryegrass': 'perennialRyegrass', 'bermuda': 'bermuda', 'zoysia': 'zoysia', 'st-augustine': 'stAugustine' };
                        const programKey = keyMap[localForm.specificGrass] + '_zone' + getParentZone(localForm.zone);
                        const program = typeof grassPrograms !== 'undefined' ? grassPrograms[programKey] : null;
                        if (!program || !program.schedule) return null;
                        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                        const currentMonth = months[new Date().getMonth()];
                        const [showFullProgram, setShowFullProgram] = React.useState(true);
                        const isCurrentMonth = (monthStr) => {
                            if (monthStr === currentMonth) return true;
                            if (monthStr && monthStr.includes('-')) {
                                const parts = monthStr.split('-');
                                const startIdx = months.indexOf(parts[0]), endIdx = months.indexOf(parts[1]), curIdx = months.indexOf(currentMonth);
                                if (startIdx >= 0 && endIdx >= 0 && curIdx >= startIdx && curIdx <= endIdx) return true;
                            }
                            return false;
                        };
                        return (
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-sm font-bold text-[#367C2B] uppercase">Full Year Program <CitationBadge sources={program.sources} label="Annual program" /></h3>
                                    <button onClick={() => setShowFullProgram(!showFullProgram)} className="text-xs font-semibold text-[#367C2B] border border-[#367C2B] rounded-lg px-3 py-1 hover:bg-[#367C2B]/10">{showFullProgram ? 'Collapse' : 'View All Months'}</button>
                                </div>
                                <div className="text-xs text-gray-500 mb-3">{program.description}</div>
                                {program.warning && <div className="mb-3 p-2 bg-yellow-50 border border-yellow-300 rounded-lg text-xs text-yellow-800">{program.warning}</div>}
                                {showFullProgram && (
                                    <div className="space-y-3">
                                        {program.schedule.map((entry, i) => (
                                            <div key={i} className={`p-3 rounded-lg border-2 ${isCurrentMonth(entry.month) ? 'border-[#367C2B] bg-[#e8f5e9]' : 'border-gray-100 bg-gray-50'}`}>
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="text-sm font-bold text-gray-800">{isCurrentMonth(entry.month) && <span className="text-[#367C2B] mr-1">‚ñ∂</span>}{entry.month}</div>
                                                    {entry.importance && <span className="text-xs font-bold text-white bg-orange-500 px-2 py-0.5 rounded-full">{entry.importance}</span>}
                                                </div>
                                                <ul className="space-y-1">{entry.tasks.map((task, j) => <li key={j} className="text-xs text-gray-700 flex items-start gap-1"><span className="text-[#367C2B] mt-0.5">¬∑</span><span>{task}</span></li>)}</ul>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    })()}
                    {grassInfo && grassInfo.keyTips && (
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-sm font-bold text-[#367C2B] uppercase mb-3">Key Tips <CitationBadge sources={grassInfo.sources} label="Care tips" /></h3>
                            <ul className="space-y-2">{grassInfo.keyTips.map((tip, i) => <li key={i} className="flex items-start gap-2 text-sm text-gray-700"><span className="text-[#367C2B] mt-0.5">üí°</span><span>{tip}</span></li>)}</ul>
                        </div>
                    )}
                    {grassInfo && grassInfo.commonIssues && (
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-sm font-bold text-orange-600 uppercase mb-3">Watch Out For <CitationBadge sources={grassInfo.sources} label="Common issues" /></h3>
                            <ul className="space-y-2">{grassInfo.commonIssues.map((issue, i) => <li key={i} className="flex items-start gap-2 text-sm text-gray-700"><span className="text-orange-500 mt-0.5">‚ö†Ô∏è</span><span>{issue}</span></li>)}</ul>
                        </div>
                    )}
                    {grassInfo && grassInfo.sources && grassInfo.sources.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                            <div className="text-xs font-bold text-gray-500 uppercase mb-2">üìö Research Sources</div>
                            <div className="space-y-1">
                                {grassInfo.sources.map((s, i) => (
                                    <div key={i} className="flex items-start gap-2 text-xs">
                                        <span className="text-[#367C2B] mt-0.5">¬∑</span>
                                        {s.url ? <a href={s.url} target="_blank" rel="noopener noreferrer" className="text-[#367C2B] hover:text-[#2d6323] underline font-semibold">{s.name}</a> : <span className="text-gray-600 font-semibold">{s.name}</span>}
                                        {s.topic && <span className="text-gray-400">‚Äî {s.topic}</span>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ‚îÄ‚îÄ‚îÄ Yearly Gameplan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const YearlyGameplan = () => {
            const [activeTab, setActiveTab] = React.useState('upcoming');
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const currentMonthIdx = new Date().getMonth();
            const currentMonth = months[currentMonthIdx];

            if (!lawnProfile || !lawnProfile.specificGrass || !lawnProfile.zone) {
                return (
                    <div className="space-y-4 animate-fade-in">
                        <h2 className="text-2xl font-bold">üìÖ Yearly Gameplan</h2>
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-5 text-center">
                            <div className="text-3xl mb-2">üå±</div>
                            <div className="font-bold text-gray-800 mb-1">Set Up Your Lawn Profile First</div>
                            <div className="text-sm text-gray-500 mb-4">We need your grass type and zone to build a personalized yearly plan.</div>
                            <button onClick={() => setView('profile')} className="px-6 py-3 bg-[#367C2B] text-white rounded-xl font-bold">
                                Set Up My Lawn ‚Üí
                            </button>
                        </div>
                    </div>
                );
            }

            const keyMap = { 'tall-fescue': 'tallFescue', 'kentucky-bluegrass': 'kentuckyBluegrass', 'perennial-ryegrass': 'perennialRyegrass', 'bermuda': 'bermuda', 'zoysia': 'zoysia', 'st-augustine': 'stAugustine' };
            const programKey = keyMap[lawnProfile.specificGrass] + '_zone' + getParentZone(lawnProfile.zone);
            const program = typeof grassPrograms !== 'undefined' ? grassPrograms[programKey] : null;
            const grassInfo = GRASS_INFO[lawnProfile.specificGrass];

            // Filter out mowing and watering tasks ‚Äî gameplan focuses on scheduled treatments
            const isGameplanTask = (task) => {
                const lower = task.toLowerCase();
                return !/\bmow(ing)?\b|\bcut (height|grass)\b|mow (weekly|at|every)|watering|irrigat|water (as needed|deeply|1|0\.|per week)|\bdrip\b/.test(lower);
            };

            // Assign a type and color to each task for visual grouping
            const getTaskMeta = (task) => {
                const lower = task.toLowerCase();
                if (/pre-emergent|pre emergent|crabgrass prev|prodiamine|dithiopyr/.test(lower))
                    return { icon: 'üõ°Ô∏è', label: 'Pre-Emergent', color: 'bg-amber-100 text-amber-800 border-amber-300' };
                if (/overseed|reseed|sow/.test(lower))
                    return { icon: 'üå±', label: 'Seeding', color: 'bg-yellow-100 text-yellow-800 border-yellow-300' };
                if (/fertili|feeding|\blb n\b|nitrogen|winterizer/.test(lower))
                    return { icon: 'üåæ', label: 'Fertilizer', color: 'bg-green-100 text-green-800 border-green-300' };
                if (/aerat/.test(lower))
                    return { icon: 'üîß', label: 'Aeration', color: 'bg-purple-100 text-purple-800 border-purple-300' };
                if (/dethatch|scalp|thatch/.test(lower))
                    return { icon: '‚úÇÔ∏è', label: 'Dethatch/Scalp', color: 'bg-stone-100 text-stone-700 border-stone-300' };
                if (/soil test|lime|ph|potassium|\biron\b/.test(lower))
                    return { icon: 'üß™', label: 'Soil Care', color: 'bg-orange-100 text-orange-800 border-orange-300' };
                if (/herbicide|weed|post-emergent|broadleaf/.test(lower))
                    return { icon: 'üåø', label: 'Weed Control', color: 'bg-red-100 text-red-800 border-red-300' };
                if (/fungicide|disease|patch|rust|blight|chinch/.test(lower))
                    return { icon: 'üíä', label: 'Disease/Pest', color: 'bg-pink-100 text-pink-800 border-pink-300' };
                if (/ryegrass|overseed.*rye|winter color/.test(lower))
                    return { icon: 'üåæ', label: 'Winter Overseed', color: 'bg-teal-100 text-teal-800 border-teal-300' };
                return { icon: 'üìã', label: 'General', color: 'bg-gray-100 text-gray-700 border-gray-300' };
            };

            const isCurrentMonthEntry = (monthStr) => {
                if (monthStr === currentMonth) return true;
                if (monthStr && monthStr.includes('-')) {
                    const parts = monthStr.split('-');
                    const s = months.indexOf(parts[0].trim()), e = months.indexOf(parts[1].trim());
                    if (s >= 0 && e >= 0 && currentMonthIdx >= s && currentMonthIdx <= e) return true;
                }
                return false;
            };

            const monthIndexForEntry = (monthStr) => {
                if (!monthStr) return -1;
                const direct = months.indexOf(monthStr);
                if (direct >= 0) return direct;
                if (monthStr.includes('-')) {
                    const s = months.indexOf(monthStr.split('-')[0].trim());
                    return s >= 0 ? s : -1;
                }
                return -1;
            };

            if (!program) {
                return (
                    <div className="space-y-4 animate-fade-in">
                        <h2 className="text-2xl font-bold">üìÖ Yearly Gameplan</h2>
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm text-amber-800">
                            No gameplan is available for {grassInfo?.name || lawnProfile.specificGrass} in Zone {lawnProfile.zone} ‚Äî this combination may not be recommended for your area.
                        </div>
                    </div>
                );
            }

            // Build list of entries with only gameplan-relevant tasks
            const allEntries = program.schedule.map(entry => ({
                ...entry,
                gameplanTasks: (entry.tasks || []).filter(isGameplanTask)
            })).filter(e => e.gameplanTasks.length > 0);

            // "Coming Up": current month + next 2 months of entries
            const upcomingEntries = allEntries.filter(entry => {
                if (isCurrentMonthEntry(entry.month)) return true;
                const entryStart = monthIndexForEntry(entry.month);
                if (entryStart < 0) return false;
                const next1 = (currentMonthIdx + 1) % 12;
                const next2 = (currentMonthIdx + 2) % 12;
                return entryStart === next1 || entryStart === next2;
            });

            const MonthCard = ({ entry, isCurrent }) => (
                <div className={`rounded-xl border-2 p-4 ${isCurrent ? 'border-[#367C2B] bg-[#e8f5e9]' : 'border-gray-100 bg-white shadow-sm'}`}>
                    <div className="flex items-center justify-between mb-3">
                        <div className="font-bold text-gray-800 flex items-center gap-1.5">
                            {isCurrent && <span className="text-[#367C2B]">‚ñ∂</span>}
                            <span>{entry.month}</span>
                            {isCurrent && <span className="text-xs font-semibold text-[#367C2B] bg-white px-2 py-0.5 rounded-full border border-[#367C2B] ml-1">Now</span>}
                        </div>
                        {entry.importance && <span className="text-xs font-bold text-white bg-orange-500 px-2 py-0.5 rounded-full">{entry.importance}</span>}
                    </div>
                    {entry.soilTemp && <div className="text-xs text-gray-500 mb-2">Target soil temp: {entry.soilTemp}</div>}
                    <div className="space-y-2">
                        {entry.gameplanTasks.map((task, j) => {
                            const meta = getTaskMeta(task);
                            const ws = weather ? getTaskWeatherStatus(task, weather) : null;
                            return (
                                <div key={j} className="flex items-start gap-2">
                                    <span className="text-base mt-0.5 shrink-0">{meta.icon}</span>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-1.5 flex-wrap">
                                            <span className={`text-xs font-bold px-1.5 py-0.5 rounded border ${meta.color}`}>{meta.label}</span>
                                            {ws && <span className={`text-xs font-semibold px-1.5 py-0.5 rounded ${ws.status === 'go' ? 'bg-[#e8f5e9] text-[#367C2B]' : ws.status === 'caution' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>{ws.status === 'go' ? '‚úì Good timing' : ws.status === 'caution' ? '‚ö† Note' : '‚úï Hold'}</span>}
                                        </div>
                                        <div className="text-sm text-gray-700 mt-0.5">{task}</div>
                                        {ws && ws.reason && <div className={`text-xs mt-0.5 ${ws.status === 'go' ? 'text-[#367C2B]' : ws.status === 'caution' ? 'text-amber-600' : 'text-red-600'}`}>{ws.reason}</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            return (
                <div className="space-y-4 animate-fade-in pb-4">
                    <div>
                        <h2 className="text-2xl font-bold">üìÖ Yearly Gameplan</h2>
                        <div className="text-sm text-gray-500 mt-0.5">
                            {grassInfo?.name || lawnProfile.specificGrass} ¬∑ Zone {lawnProfile.zone}
                            {lawnProfile.lawnSize && ` ¬∑ ${Number(lawnProfile.lawnSize).toLocaleString()} sq ft`}
                        </div>
                    </div>

                    {program.warning && (
                        <div className="bg-amber-50 border border-amber-300 rounded-xl p-3 text-sm text-amber-800">
                            ‚ö†Ô∏è {program.warning}
                        </div>
                    )}

                    {/* Tabs */}
                    <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                        {[{key:'upcoming',label:'Coming Up'},{key:'full',label:'Full Year'}].map(({key,label}) => (
                            <button key={key} onClick={() => setActiveTab(key)}
                                className={`flex-1 py-2 text-sm font-semibold rounded-md transition btn-press ${activeTab === key ? 'bg-[#367C2B] text-white shadow' : 'text-gray-600'}`}>
                                {label}
                            </button>
                        ))}
                    </div>

                    {activeTab === 'upcoming' && (
                        <div className="space-y-3">
                            {upcomingEntries.length === 0 ? (
                                <div className="bg-gray-50 rounded-xl p-6 text-center">
                                    <div className="text-2xl mb-2">‚úÖ</div>
                                    <div className="font-semibold text-gray-700">You're in a quiet period</div>
                                    <div className="text-sm text-gray-500 mt-1">No scheduled treatments in the next couple months. Switch to Full Year to see the whole plan.</div>
                                </div>
                            ) : (
                                upcomingEntries.map((entry, i) => (
                                    <MonthCard key={i} entry={entry} isCurrent={isCurrentMonthEntry(entry.month)} />
                                ))
                            )}
                        </div>
                    )}

                    {activeTab === 'full' && (
                        <div className="space-y-3">
                            <div className="text-xs text-gray-500 px-1">{program.description}</div>
                            {allEntries.map((entry, i) => (
                                <MonthCard key={i} entry={entry} isCurrent={isCurrentMonthEntry(entry.month)} />
                            ))}
                        </div>
                    )}

                    {program.sources && program.sources.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                            <div className="text-xs font-bold text-gray-500 uppercase mb-2">üìö Research Sources</div>
                            <div className="space-y-1">
                                {program.sources.map((s, i) => (
                                    <div key={i} className="flex items-start gap-2 text-xs">
                                        <span className="text-[#367C2B] mt-0.5">¬∑</span>
                                        <a href={s.url} target="_blank" rel="noopener noreferrer" className="text-[#367C2B] hover:text-[#2d6323] underline font-semibold">{s.institution || s.name}</a>
                                        {s.title && <span className="text-gray-400">‚Äî {s.title}</span>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = () => {
            const [expandedRecentId, setExpandedRecentId] = useState(null);
            const now = new Date();
            const filtered = statsView === 'year' ? activities.filter(a => new Date(a.date).getFullYear() === now.getFullYear())
                : statsView === 'season' ? activities.filter(a => {
                    const year = now.getFullYear();
                    const d = new Date(a.date);
                    return d >= new Date(year, 3, 1) && d <= new Date(year, 9, 31);
                })
                : activities;
            const stats = {
                total: filtered.length,
                mowing: filtered.filter(a => a.type === 'mowing').length,
                fertilizer: filtered.filter(a => a.type === 'fertilizer').length,
                watering: filtered.filter(a => a.type === 'watering').length,
                seeding: filtered.filter(a => a.type === 'seeding').length,
                trimming: filtered.filter(a => a.type === 'trimming').length,
                aeration: filtered.filter(a => a.type === 'aeration').length,
                maintenance: filtered.filter(a => a.type === 'maintenance').length,
                totalHours: filtered.reduce((sum, a) => sum + (parseFloat(a.data?.duration) || 0), 0) / 60,
                // PREMIUM_FEATURE: cost tracking ‚Äî available to all users now; gated to premium subscribers in a future release
                totalSpend: filtered.reduce((sum, a) => sum + (a.cost > 0 ? a.cost : 0), 0)
            };
            const monthlyData = [];
            for (let i = 5; i >= 0; i--) {
                const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const count = filtered.filter(a => { const d = new Date(a.date); return d.getMonth() === month.getMonth() && d.getFullYear() === month.getFullYear(); }).length;
                monthlyData.push({ month: month.toLocaleDateString('en', { month: 'short' }), count });
            }
            const recent = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
            const breakdownItems = [
                { type: 'mowing', label: 'Mowing', count: stats.mowing },
                { type: 'fertilizer', label: 'Fertilizer', count: stats.fertilizer },
                { type: 'watering', label: 'Watering', count: stats.watering },
                { type: 'seeding', label: 'Seeding', count: stats.seeding },
                { type: 'aeration', label: 'Aeration', count: stats.aeration },
                { type: 'maintenance', label: 'Maintenance', count: stats.maintenance }
            ];
            const maxBreakdown = Math.max(...breakdownItems.map(b => b.count)) || 1;
            const maxMonthly = Math.max(...monthlyData.map(d => d.count)) || 1;
            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold mb-4">üìä Dashboard</h2>
                    <div className="flex gap-2 bg-gray-100 p-1 rounded-lg mb-4">
                        {[{key:'year',label:'This Year'},{key:'season',label:'Season'},{key:'all',label:'All Time'}].map(({key,label}) => (
                            <button key={key} onClick={() => setStatsView(key)} className={`flex-1 py-2 px-4 rounded-md text-sm font-semibold transition btn-press ${statsView === key ? 'bg-[#367C2B] text-white shadow' : 'text-gray-600'}`}>{label}</button>
                        ))}
                    </div>
                    <div className="grid grid-cols-4 gap-2 mb-2">
                        <div className="bg-white rounded-xl p-3 shadow-md text-center border-t-2 border-[#367C2B]"><div className="text-2xl font-bold text-[#367C2B]">{stats.total}</div><div className="text-xs text-gray-500">Total</div></div>
                        <div className="bg-white rounded-xl p-3 shadow-md text-center border-t-2 border-[#367C2B]"><div className="text-2xl font-bold text-[#367C2B]">{stats.mowing}</div><div className="text-xs text-gray-500">Mows</div></div>
                        <div className="bg-white rounded-xl p-3 shadow-md text-center border-t-2 border-[#F97316]"><div className="text-2xl font-bold text-[#F97316]">{stats.fertilizer}</div><div className="text-xs text-gray-500">Feeds</div></div>
                        <div className="bg-white rounded-xl p-3 shadow-md text-center border-t-2 border-[#3B82F6]"><div className="text-2xl font-bold text-[#3B82F6]">{stats.totalHours.toFixed(1)}</div><div className="text-xs text-gray-500">Hours</div></div>
                    </div>
                    {/* PREMIUM_FEATURE: cost tracking spend summary */}
                    {stats.totalSpend > 0 && (
                        <div className="bg-white rounded-xl px-4 py-3 shadow-md mb-4 flex items-center justify-between border-l-4 border-emerald-500">
                            <div>
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-widest">Season Spend</div>
                                <div className="text-xl font-extrabold text-gray-800">${stats.totalSpend.toFixed(2)}</div>
                            </div>
                            <div className="text-right text-xs text-gray-400">
                                <div>{filtered.filter(a => a.cost > 0).length} logged costs</div>
                                <div className="font-semibold text-gray-600">${(stats.totalSpend / (filtered.filter(a => a.cost > 0).length || 1)).toFixed(2)} avg</div>
                            </div>
                        </div>
                    )}
                    {!stats.totalSpend && (
                        <div className="mb-4 px-3 py-2 bg-gray-50 rounded-xl border border-dashed border-gray-200 text-xs text-gray-400 text-center">
                            Add a <span className="font-semibold">Cost</span> when logging activities to track season spend
                        </div>
                    )}
                    <div className="bg-white rounded-xl p-4 shadow-md mb-4">
                        <h3 className="text-lg font-bold mb-3">Activity Breakdown</h3>
                        <div className="space-y-2">
                            {breakdownItems.map(({ type, label, count }) => {
                                const color = (ACTIVITY_COLORS[type] || ACTIVITY_COLORS.mowing).hex;
                                return (
                                    <div key={type} className="flex items-center gap-3">
                                        <div className="w-20 text-xs text-gray-600 font-medium">{label}</div>
                                        <div className="flex-1 bg-gray-100 rounded-full h-7 relative overflow-hidden">
                                            <div className="h-full rounded-full transition-all duration-500" style={{ width: `${(count / maxBreakdown) * 100}%`, backgroundColor: color }} />
                                            <div className="absolute inset-0 flex items-center justify-end pr-2">
                                                <span className="text-xs font-bold" style={{ color: count > 0 ? 'white' : '#9CA3AF' }}>{count}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="bg-white rounded-xl p-4 shadow-md mb-4">
                        <h3 className="text-lg font-bold mb-3">Monthly Trend</h3>
                        <div className="flex items-end justify-between gap-1" style={{ height: '100px' }}>
                            {monthlyData.map((data, i) => (
                                <div key={i} className="flex-1 flex flex-col items-center gap-1">
                                    <div className="w-full flex items-end justify-center" style={{ height: '80px' }}>
                                        <div className="w-full bg-[#367C2B] rounded-t transition-all duration-500 flex items-end justify-center pb-0.5"
                                            style={{ height: `${(data.count / maxMonthly) * 100}%`, minHeight: data.count > 0 ? '20px' : '0' }}>
                                            {data.count > 0 && <span className="text-xs font-bold text-white leading-none">{data.count}</span>}
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-500 font-medium">{data.month}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-white rounded-xl p-4 shadow-md">
                        <h3 className="text-lg font-bold mb-3">üïí Recent Activity</h3>
                        {recent.length > 0 ? recent.map(activity => {
                            const colors = ACTIVITY_COLORS[activity.type] || ACTIVITY_COLORS.mowing;
                            const daysSince = Math.floor((new Date() - new Date(activity.date)) / (1000 * 60 * 60 * 24));
                            const timeAgo = daysSince === 0 ? 'Today' : daysSince === 1 ? 'Yesterday' : `${daysSince} days ago`;
                            return (
                                <div key={activity.id} className={`pb-3 mb-3 border-b last:border-0 cursor-pointer card-hover pl-3 border-l-2 ${colors.border}`} onClick={() => setExpandedRecentId(expandedRecentId === activity.id ? null : activity.id)}>
                                    <div className="flex items-center gap-3">
                                        <div className="text-2xl">{ACTIVITY_TYPES[activity.type]?.icon || 'üìã'}</div>
                                        <div className="flex-1"><div className={`font-semibold ${colors.text}`}>{ACTIVITY_TYPES[activity.type]?.name}</div><div className="text-sm text-gray-500">{timeAgo}</div></div>
                                        <span className="text-gray-400 text-xs">{expandedRecentId === activity.id ? '‚ñ≤' : '‚ñº'}</span>
                                    </div>
                                    {expandedRecentId === activity.id && <ActivityDetails activity={activity} />}
                                </div>
                            );
                        }) : (
                            <div className="text-center py-8 text-gray-500"><div className="text-4xl mb-2">üìã</div><div className="text-sm">No activities yet</div></div>
                        )}
                    </div>
                </div>
            );
        };

        const Settings = () => {
            const exportData = () => {
                const data = { activities, equipment, profile: lawnProfile };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `yardstick-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };
            const resetData = () => {
                if (confirm('‚ö†Ô∏è Delete ALL data? This cannot be undone!')) {
                    localStorage.removeItem('lawnCareActivities');
                    localStorage.removeItem('lawnCareEquipment');
                    localStorage.removeItem('lawnProfile');
                    alert('‚úÖ Data cleared');
                    window.location.reload();
                }
            };
            return (
                <div>
                    <h2 className="text-2xl font-bold mb-6">‚öôÔ∏è Settings</h2>

                    {/* Account section */}
                    <div className="bg-white rounded-xl p-4 shadow mb-4">
                        <h3 className="text-lg font-bold mb-4">üë§ Account</h3>
                        {store.isCloud && currentUser ? (
                            <div>
                                <div className="flex items-center gap-3 mb-4 p-3 bg-[#e8f5e9] rounded-xl">
                                    <div className="text-3xl">‚òÅÔ∏è</div>
                                    <div>
                                        <div className="font-bold text-[#367C2B]">Cloud Sync Active</div>
                                        <div className="text-xs text-gray-600">{currentUser.displayName || currentUser.email}</div>
                                        <div className="text-xs text-gray-500 mt-0.5">Your data is saved securely to the cloud</div>
                                    </div>
                                </div>
                                <button onClick={handleSignOut} className="w-full py-3 px-4 bg-gray-100 text-gray-700 rounded-lg font-semibold">Sign Out</button>
                            </div>
                        ) : (
                            <div>
                                <div className="flex items-center gap-3 mb-4 p-3 bg-amber-50 rounded-xl">
                                    <div className="text-3xl">üíæ</div>
                                    <div>
                                        <div className="font-bold text-amber-700">Local Storage Only</div>
                                        <div className="text-xs text-gray-600">Data is saved to this browser only</div>
                                        <div className="text-xs text-gray-500 mt-0.5">Sign in to sync across devices and protect your data</div>
                                    </div>
                                </div>
                                {fb.configured ? (
                                    <button onClick={() => setShowAuthModal(true)} className="w-full py-3 px-4 bg-[#367C2B] text-white rounded-lg font-semibold">
                                        Sign In / Create Account ‚Üí
                                    </button>
                                ) : (
                                    <div className="p-3 bg-gray-50 rounded-lg text-xs text-gray-500 text-center">
                                        Firebase not yet configured ‚Äî cloud sync coming soon
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-xl p-4 shadow mb-4">
                        <h3 className="text-lg font-bold mb-4">üíæ Data Management</h3>
                        <button onClick={exportData} className="w-full py-3 px-4 bg-[#367C2B] text-white rounded-lg font-semibold mb-3">üì• Export Data Backup</button>
                        <button onClick={resetData} className="w-full py-3 px-4 bg-red-100 text-red-700 rounded-lg font-semibold">üóëÔ∏è Reset All Data</button>
                    </div>

                    <div className="bg-white rounded-xl p-4 shadow">
                        <h3 className="text-lg font-bold mb-2">‚ÑπÔ∏è About</h3>
                        <p className="text-sm text-gray-600 font-semibold">Yardstick v9.0</p>
                        <p className="text-xs text-gray-500 mt-1">Research-backed lawn care for DIY homeowners</p>
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <div className="border-l-3 border-[#367C2B] pl-3" style={{borderLeft: '3px solid #367C2B'}}>
                                <div className="text-sm font-bold text-[#367C2B]">v9.0 <span className="text-xs font-normal text-gray-400">Feb 2026</span></div>
                                <ul className="text-xs text-gray-600 mt-1 space-y-0.5">
                                    <li>+ Optional Firebase account ‚Äî guest users keep localStorage</li>
                                    <li>+ Cloud sync: activities, equipment, and profile sync across devices</li>
                                    <li>+ Google Sign-In + email/password authentication</li>
                                    <li>+ Sync status banner shows cloud/local mode at a glance</li>
                                    <li>+ Account management in Settings</li>
                                    <li>+ App rebranded to Yardstick</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductGuide = () => {
            const [category, setCategory] = useState('mowers');
            const [mowerType, setMowerType] = useState('');
            const [brandFilter, setBrandFilter] = useState('');
            const [compareList, setCompareList] = useState([]);
            const [showCompare, setShowCompare] = useState(false);
            const [expandedId, setExpandedId] = useState(null);
            const allProducts = (PRODUCT_DATABASE[category] || []).filter(p => !p.id.includes('-other'));
            const brands = [...new Set(allProducts.map(p => p.brand))].sort();
            let filtered = allProducts;
            if (category === 'mowers' && mowerType) filtered = filtered.filter(p => p.mowerCategory === mowerType);
            if (brandFilter) filtered = filtered.filter(p => p.brand === brandFilter);
            const toggleCompare = (product) => {
                if (compareList.find(p => p.id === product.id)) setCompareList(compareList.filter(p => p.id !== product.id));
                else if (compareList.length < 3) setCompareList([...compareList, product]);
            };
            const typeLabels = { mowers: 'Mowers', spreaders: 'Spreaders', trimmers: 'Trimmers', fertilizers: 'Fertilizers', seeds: 'Grass Seed' };
            const typeIcons = { mowers: 'üöú', spreaders: 'üì°', trimmers: '‚úÇÔ∏è', fertilizers: 'üåæ', seeds: 'üå±' };
            const renderSpec = (label, value) => {
                if (!value) return null;
                return <div className="flex justify-between text-xs py-1 border-b border-gray-100"><span className="text-gray-500">{label}</span><span className="font-semibold text-gray-800 text-right">{value}</span></div>;
            };
            const ProductCard = ({ product }) => {
                const isExpanded = expandedId === product.id;
                const isCompared = compareList.find(p => p.id === product.id);
                return (
                    <div className={`bg-white rounded-xl shadow border-2 transition ${isCompared ? 'border-[#367C2B]' : 'border-gray-100'}`}>
                        <div className="p-3 cursor-pointer" onClick={() => setExpandedId(isExpanded ? null : product.id)}>
                            <div className="flex items-start justify-between">
                                <div className="flex-1">
                                    <div className="text-sm font-bold text-gray-900">{product.name}</div>
                                    <div className="text-xs text-[#367C2B] font-semibold">{product.brand}</div>
                                    {product.type && <div className="text-xs text-gray-500 mt-0.5">{product.type}</div>}
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={(e) => { e.stopPropagation(); toggleCompare(product); }}
                                        className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${isCompared ? 'bg-[#367C2B] text-white' : compareList.length >= 3 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-100 text-gray-700 hover:bg-[#367C2B] hover:text-white'}`}
                                        disabled={!isCompared && compareList.length >= 3}>
                                        {isCompared ? '‚úì Selected' : '+ Compare'}
                                    </button>
                                    <span className="text-gray-400 text-xs">{isExpanded ? '‚ñ≤' : '‚ñº'}</span>
                                </div>
                            </div>
                        </div>
                        {isExpanded && (
                            <div className="px-3 pb-3 border-t border-gray-100 pt-2">
                                {renderSpec('Brand', product.brand)}
                                {product.deck && renderSpec('Deck Size', product.deck)}
                                {product.type && renderSpec('Type', product.type)}
                                {product.features && renderSpec('Features', product.features)}
                                {product.npk && renderSpec('NPK', product.npk)}
                                {product.coverage && renderSpec('Coverage', product.coverage)}
                            </div>
                        )}
                    </div>
                );
            };
            return (
                <div>
                    <h2 className="text-xl font-bold mb-4">üìñ Product Guide</h2>
                    <div className="flex gap-1 bg-gray-100 p-1 rounded-lg mb-4 overflow-x-auto">
                        {Object.entries(typeLabels).map(([key, label]) => (
                            <button key={key} onClick={() => { setCategory(key); setMowerType(''); setBrandFilter(''); setCompareList([]); setExpandedId(null); }}
                                className={`flex-shrink-0 py-2 px-3 rounded-md text-xs font-semibold transition ${category === key ? 'bg-[#367C2B] text-white shadow' : 'text-gray-600 hover:text-gray-900'}`}>
                                {typeIcons[key]} {label}
                            </button>
                        ))}
                    </div>
                    <div className="bg-white rounded-xl shadow p-3 mb-4">
                        <div className="flex items-center gap-2 flex-wrap">
                            {category === 'mowers' && (
                                <div className="flex gap-1">
                                    {['', 'Walk Behind', 'Riding', 'Zero Turn'].map(mt => (
                                        <button key={mt} onClick={() => { setMowerType(mt); setExpandedId(null); }}
                                            className={`px-2 py-1 rounded text-xs font-semibold ${mowerType === mt ? 'bg-[#367C2B] text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            {mt || 'All'}
                                        </button>
                                    ))}
                                </div>
                            )}
                            <select value={brandFilter} onChange={(e) => { setBrandFilter(e.target.value); setExpandedId(null); }} className="px-2 py-1 border rounded text-xs">
                                <option value="">All Brands ({brands.length})</option>
                                {brands.map(b => <option key={b} value={b}>{b}</option>)}
                            </select>
                            <span className="text-xs text-gray-400 ml-auto">{filtered.length} products</span>
                        </div>
                    </div>
                    {compareList.length > 0 && (
                        <div className="fixed bottom-0 left-0 right-0 z-50 bg-white border-t-2 border-[#367C2B] shadow-2xl" style={{animation: 'slideUpBounce 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)'}}>
                            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
                                <div className="flex-1 min-w-0"><div className="text-xs text-gray-500 font-semibold">{compareList.length}/3 selected</div><div className="text-sm font-bold text-gray-800 truncate">{compareList.map(p => p.name).join(' vs ')}</div></div>
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <button onClick={() => setCompareList([])} className="px-3 py-2 text-xs font-semibold text-gray-500 border border-gray-300 rounded-lg">Clear</button>
                                    {compareList.length >= 2 && <button onClick={() => setShowCompare(true)} className="px-5 py-2.5 bg-[#FFDE00] text-[#367C2B] rounded-lg text-sm font-extrabold shadow-lg" style={{animation: 'pulseGlow 2s ease-in-out infinite'}}>Compare Now ‚Üí</button>}
                                </div>
                            </div>
                        </div>
                    )}
                    <div className={`space-y-2 ${compareList.length > 0 ? 'pb-20' : ''}`}>
                        {filtered.map(product => <ProductCard key={product.id} product={product} />)}
                    </div>
                    {filtered.length === 0 && <div className="bg-white rounded-xl shadow p-8 text-center text-gray-500">No products match the current filters</div>}
                </div>
            );
        };

        const ResearchSourcesPage = () => (
            <div>
                <h2 className="text-2xl font-bold mb-6">üìö Research Sources</h2>
                <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
                    <p className="text-sm text-blue-900"><strong>Evidence-Based Recommendations:</strong> All lawn care guidance is based on peer-reviewed research from {RESEARCH_SOURCES.length} university extension programs.</p>
                </div>
                <div className="bg-white rounded-xl p-4 shadow mb-4">
                    <div className="grid grid-cols-2 gap-3">
                        <div className="text-center p-3 bg-gray-50 rounded"><div className="text-3xl font-bold text-[#367C2B]">{RESEARCH_SOURCES.length}</div><div className="text-sm text-gray-600">Universities</div></div>
                        <div className="text-center p-3 bg-gray-50 rounded"><div className="text-3xl font-bold text-[#367C2B]">{RESEARCH_SOURCES.reduce((sum, s) => sum + s.count, 0)}</div><div className="text-sm text-gray-600">Publications</div></div>
                    </div>
                </div>
                <div className="space-y-4">
                    {RESEARCH_SOURCES.map(source => (
                        <div key={source.id} className="bg-white rounded-xl p-4 shadow-md border-l-4 border-[#367C2B]">
                            <h3 className="text-lg font-bold text-gray-900">{source.name}</h3>
                            <p className="text-sm text-gray-600">{source.count} publications referenced</p>
                            {source.topics && <div className="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-700">{source.topics}</div>}
                            {source.url && <a href={source.url} target="_blank" rel="noopener noreferrer" className="text-[#367C2B] font-semibold text-sm underline mt-3 inline-block">Visit Extension Website ‚Üí</a>}
                        </div>
                    ))}
                </div>
            </div>
        );

        // Loading screen
        if (!authReady || dataLoading) {
            return (
                <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center">
                    <div className="text-5xl mb-4">üå±</div>
                    <div className="text-xl font-bold text-[#367C2B] mb-2">Yardstick</div>
                    <div className="text-sm text-gray-500">Loading your lawn data...</div>
                    <div className="mt-6 flex gap-1">
                        {[0,1,2].map(i => <div key={i} className="w-2 h-2 bg-[#367C2B] rounded-full animate-bounce" style={{animationDelay: `${i*0.15}s`}}></div>)}
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen bg-gray-50">
                {showAuthModal && (
                    <AuthModal
                        onClose={() => setShowAuthModal(false)}
                        onSuccess={(user) => { setCurrentUser(user); setShowAuthModal(false); }}
                    />
                )}

                <header className="sticky top-0 z-40" style={{background: 'linear-gradient(135deg, #367C2B 0%, #4a9c3a 100%)'}}>
                    <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                        <button onClick={() => { setView(null); setSelectedActivityType(null); }} className="flex items-center btn-press">
                            <div className="flex items-center gap-2">
                                <img src="logo.svg" alt="Yardstick logo" className="h-9 w-9" />
                                <span className="text-2xl font-bold text-white">Yardstick</span>
                            </div>
                        </button>
                        <div className="flex items-center gap-2">
                            <button onClick={() => { setView('add'); setSelectedActivityType(null); }} className="flex items-center gap-1.5 bg-white/20 hover:bg-white/30 text-white text-xs font-bold px-3 py-1.5 rounded-full btn-press transition border border-white/20">
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2.5}>
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/>
                                </svg>
                                Log
                            </button>
                            <button onClick={() => setView(view === 'menu' ? null : 'menu')} className="p-2 rounded-lg hover:bg-white/20 btn-press transition">
                                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    {view === 'menu' && (
                        <div className="border-t border-white/20 bg-white shadow-lg menu-slide">
                            <div className="max-w-5xl mx-auto px-4 py-2">
                                {[
                                    { key: 'add', icon: '‚ûï', label: 'Add Activity' },
                                    { key: 'history', icon: 'üìã', label: 'History' },
                                    { key: 'garage', icon: 'üè†', label: 'My Garage' },
                                    { key: 'profile', icon: 'üå±', label: 'My Yard' },
                                    { key: 'gameplan', icon: 'üìÖ', label: 'Yearly Gameplan' },
                                    { key: 'products', icon: 'üìñ', label: 'Product Guide' },
                                    { key: 'sources', icon: 'üìö', label: 'Research Sources' },
                                    { key: 'settings', icon: '‚öôÔ∏è', label: 'Settings' },
                                ].map(item => (
                                    <button key={item.key} onClick={() => { setView(item.key); setSelectedActivityType(null); }} className="w-full text-left px-4 py-3 rounded-lg nav-item hover:bg-[#367C2B]/10 flex items-center gap-3">
                                        <span className="text-2xl">{item.icon}</span>
                                        <span className="text-lg font-semibold">{item.label}</span>
                                    </button>
                                ))}
                                <div className="border-t border-gray-100 mt-2 pt-2">
                                    <button
                                        onClick={() => {
                                            if (!currentUser) {
                                                setView(null);
                                                setShowAuthModal(true);
                                            } else {
                                                setView('settings');
                                                setSelectedActivityType(null);
                                            }
                                        }}
                                        className="w-full text-left px-4 py-3 rounded-lg nav-item hover:bg-[#367C2B]/10 flex items-center gap-3"
                                    >
                                        <svg className="w-7 h-7 flex-shrink-0 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                        <span className="text-lg font-semibold text-gray-700">
                                            {currentUser ? (currentUser.displayName || currentUser.email || 'My Account') : 'Sign In / Create Account'}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </header>

                {/* Sync status banner ‚Äî shown below header */}
                <SyncBanner
                    isCloud={store.isCloud}
                    currentUser={currentUser}
                    onSignIn={() => setShowAuthModal(true)}
                    onSignOut={handleSignOut}
                    firebaseConfigured={fb.configured}
                />

                <SeasonBanner />

                <div className="max-w-5xl mx-auto p-2 md:p-3">
                    {!view && (
                        <div className="space-y-3">
                            {/* Greeting */}
                            <div className="flex items-start justify-between pt-1">
                                <div>
                                    <div className="text-xs font-semibold text-gray-400 uppercase tracking-widest">
                                        {(() => { const h = new Date().getHours(); return h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening'; })()}
                                    </div>
                                    <div className="text-2xl font-extrabold text-gray-800 leading-tight">Your Lawn Dashboard</div>
                                    {weather && <div className="text-xs text-gray-400 mt-0.5">{weather.location}</div>}
                                </div>
                                <div className="flex flex-col items-end gap-1.5 flex-shrink-0 ml-3">
                                    {(() => {
                                        const thisMonth = new Date().getMonth();
                                        const thisYear = new Date().getFullYear();
                                        const monthCount = activities.filter(a => { const d = new Date(a.date); return d.getMonth() === thisMonth && d.getFullYear() === thisYear; }).length;
                                        return (
                                            <div className="bg-[#e8f5e9] border border-[#367C2B]/30 text-[#367C2B] text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">
                                                {monthCount} {monthCount === 1 ? 'activity' : 'activities'} this month
                                            </div>
                                        );
                                    })()}
                                    {/* Consistency streak badge */}
                                    {(() => {
                                        if (activities.length === 0) return null;
                                        const now = new Date();
                                        let month = now.getMonth(), year = now.getFullYear(), streak = 0;
                                        for (let i = 0; i < 24; i++) {
                                            if (!activities.some(a => { const d = new Date(a.date); return d.getMonth() === month && d.getFullYear() === year; })) break;
                                            streak++;
                                            if (--month < 0) { month = 11; year--; }
                                        }
                                        if (streak < 2) return null;
                                        return (
                                            <div className="bg-orange-50 border border-orange-200 text-orange-600 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">
                                                üî• {streak}-month streak
                                            </div>
                                        );
                                    })()}
                                    {/* Critical windows badge */}
                                    {(() => {
                                        if (!lawnProfile || !lawnProfile.specificGrass || !lawnProfile.zone) return null;
                                        const keyMap = { 'tall-fescue': 'tallFescue', 'kentucky-bluegrass': 'kentuckyBluegrass', 'perennial-ryegrass': 'perennialRyegrass', 'bermuda': 'bermuda', 'zoysia': 'zoysia', 'st-augustine': 'stAugustine' };
                                        const program = typeof grassPrograms !== 'undefined' ? grassPrograms[keyMap[lawnProfile.specificGrass] + '_zone' + getParentZone(lawnProfile.zone)] : null;
                                        if (!program) return null;
                                        const year = new Date().getFullYear(), curMon = new Date().getMonth();
                                        const mNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                                        let hit = 0, total = 0;
                                        (program.schedule || []).filter(e => e.importance).forEach(entry => {
                                            const startIdx = mNames.indexOf((entry.month || '').split('-')[0].trim());
                                            if (startIdx < 0 || startIdx > curMon) return;
                                            total++;
                                            const endIdx = Math.min(entry.month.includes('-') ? mNames.indexOf(entry.month.split('-')[1].trim()) : startIdx, curMon);
                                            for (let m = startIdx; m <= endIdx; m++) {
                                                if (activities.some(a => { const d = new Date(a.date); return d.getFullYear() === year && d.getMonth() === m; })) { hit++; break; }
                                            }
                                        });
                                        if (total === 0) return null;
                                        return (
                                            <div className={`text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap border ${hit === total ? 'bg-[#e8f5e9] border-[#367C2B]/30 text-[#367C2B]' : 'bg-amber-50 border-amber-200 text-amber-600'}`}>
                                                ‚≠ê {hit}/{total} key windows
                                            </div>
                                        );
                                    })()}
                                    {activities.length > 0 && (() => {
                                        const last = [...activities].sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                                        const days = Math.floor((new Date() - new Date(last.date)) / (1000*60*60*24));
                                        return <div className="text-xs text-gray-400">{days === 0 ? 'Last log: Today' : days === 1 ? 'Last log: Yesterday' : `Last log: ${days}d ago`}</div>;
                                    })()}
                                </div>
                            </div>
                            {/* This Week's Priority */}
                            {(() => {
                                if (!lawnProfile || !lawnProfile.specificGrass || !lawnProfile.zone) return null;
                                const keyMap = { 'tall-fescue': 'tallFescue', 'kentucky-bluegrass': 'kentuckyBluegrass', 'perennial-ryegrass': 'perennialRyegrass', 'bermuda': 'bermuda', 'zoysia': 'zoysia', 'st-augustine': 'stAugustine' };
                                const programKey = keyMap[lawnProfile.specificGrass] + '_zone' + getParentZone(lawnProfile.zone);
                                const program = typeof grassPrograms !== 'undefined' ? grassPrograms[programKey] : null;
                                if (!program) return null;
                                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                                const curIdx = new Date().getMonth();
                                const curMonth = monthNames[curIdx];
                                const isMatch = (mStr) => {
                                    if (mStr === curMonth) return true;
                                    if (mStr && mStr.includes('-')) {
                                        const parts = mStr.split('-');
                                        const s = monthNames.indexOf(parts[0].trim()), e = monthNames.indexOf(parts[1].trim());
                                        return s >= 0 && e >= 0 && curIdx >= s && curIdx <= e;
                                    }
                                    return false;
                                };
                                const isGameplanTask = (t) => !/\bmow(ing)?\b|mow (weekly|at|every)|watering|irrigat|water (as needed|deeply|1|0\.|per week)/.test(t.toLowerCase());
                                const currentEntry = program.schedule.find(e => isMatch(e.month));
                                const gameplanTasks = currentEntry ? (currentEntry.tasks || []).filter(isGameplanTask) : [];
                                const nextEntry = program.schedule.find(e => {
                                    const s = monthNames.indexOf((e.month || '').split('-')[0].trim());
                                    return s === (curIdx + 1) % 12 || s === (curIdx + 2) % 12;
                                });
                                const upNext = nextEntry ? nextEntry.month : null;
                                const taskIcons = { 'pre-emergent': 'üõ°Ô∏è', 'fertili': 'üåæ', 'aerat': 'üîß', 'overseed': 'üå±', 'seed': 'üå±', 'soil test': 'üß™', 'lime': 'üß™', 'dethatch': '‚úÇÔ∏è', 'scalp': '‚úÇÔ∏è', 'weed': 'üåø', 'herbicide': 'üåø', 'fungicide': 'üíä', 'chinch': 'üíä' };
                                const getIcon = (task) => { const lower = task.toLowerCase(); for (const [k, v] of Object.entries(taskIcons)) { if (lower.includes(k)) return v; } return 'üìã'; };
                                const scoredTasks = gameplanTasks.map(task => {
                                    const ws = getTaskWeatherStatus(task, weather);
                                    const order = !ws ? 1 : ws.status === 'go' ? 0 : ws.status === 'caution' ? 1 : 2;
                                    return { task, ws, order };
                                }).sort((a, b) => a.order - b.order);
                                const weekLabel = (() => {
                                    const d = new Date().getDate();
                                    return d <= 7 ? 'Early' : d <= 14 ? 'Mid' : d <= 21 ? 'Mid‚ÄìLate' : 'Late';
                                })();
                                return (
                                    <button onClick={() => setView('gameplan')} className="w-full bg-white rounded-2xl shadow-sm border border-[#367C2B]/20 p-4 card-hover btn-press text-left">
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-2">
                                                <div className="w-8 h-8 rounded-lg bg-[#e8f5e9] flex items-center justify-center text-lg flex-shrink-0">üìÖ</div>
                                                <div>
                                                    <div className="text-sm font-bold text-gray-800">This Week's Priority</div>
                                                    <div className="text-xs text-gray-400">{weekLabel} {curMonth}{currentEntry?.importance ? ` ¬∑ ${currentEntry.importance}` : ''}</div>
                                                </div>
                                            </div>
                                            <span className="text-xs font-bold text-[#367C2B]">Full plan ‚Üí</span>
                                        </div>
                                        {scoredTasks.length > 0 ? (
                                            <div className="space-y-1.5 mt-2">
                                                {scoredTasks.slice(0, 3).map(({ task, ws }, i) => {
                                                    const dot = !ws ? null : ws.status === 'go' ? 'üü¢' : ws.status === 'caution' ? 'üü°' : 'üî¥';
                                                    return (
                                                        <div key={i} className="flex items-start gap-2 text-xs text-gray-600">
                                                            <span className="flex-shrink-0 mt-0.5">{getIcon(task)}</span>
                                                            <span className="flex-1 leading-snug">{task}</span>
                                                            {dot && <span className="flex-shrink-0">{dot}</span>}
                                                        </div>
                                                    );
                                                })}
                                                {scoredTasks.length > 3 && <div className="text-xs text-[#367C2B] font-semibold">+{scoredTasks.length - 3} more this month</div>}
                                                {weather && <div className="text-xs text-gray-400 mt-1.5 pt-1.5 border-t border-gray-100">üü¢ do now ¬∑ üü° proceed carefully ¬∑ üî¥ hold</div>}
                                                {upNext && !weather && <div className="text-xs text-gray-400 mt-1 pt-1 border-t border-gray-100">Up next: {upNext}</div>}
                                            </div>
                                        ) : (
                                            <div className="text-xs text-gray-500 mt-1">
                                                {upNext ? `Quiet period ‚Äî next tasks in ${upNext}` : 'No scheduled treatments this month'}
                                            </div>
                                        )}
                                    </button>
                                );
                            })()}
                            {/* Weather card */}
                            <WeatherSnapshot />
                            {/* Frost countdown banner */}
                            {(() => {
                                if (!lawnProfile || !lawnProfile.zone) return null;
                                const zd = ZONE_INFO[lawnProfile.zone] || ZONE_INFO[getParentZone(lawnProfile.zone)];
                                if (!zd || !zd.firstFrost) return null;
                                const now = new Date(), yr = now.getFullYear();
                                const firstFrost = new Date(yr, zd.firstFrost.month - 1, zd.firstFrost.day);
                                const lastFrost  = new Date(yr, zd.lastFrost.month  - 1, zd.lastFrost.day );
                                const dToFirst = Math.floor((firstFrost - now) / 864e5);
                                const dToLast  = Math.floor((lastFrost  - now) / 864e5);
                                let banner = null;
                                if (dToFirst >= 0 && dToFirst <= 45) {
                                    const urgency = dToFirst <= 7 ? 'urgent' : dToFirst <= 21 ? 'warning' : 'info';
                                    const advice  = dToFirst <= 7  ? 'Finish seeding immediately ‚Äî seedlings need 6 weeks to harden.' :
                                                    dToFirst <= 21 ? 'Wrap up overseeding and final fall fertilization.' :
                                                    'Plan final seeding, fertilization, and lime applications.';
                                    banner = { icon: 'üçÇ', label: `First frost ~${zd.firstFrost.month}/${zd.firstFrost.day}`, days: dToFirst, advice, urgency };
                                } else if (dToLast >= 0 && dToLast <= 30) {
                                    banner = { icon: '‚ùÑÔ∏è', label: `Last frost ~${zd.lastFrost.month}/${zd.lastFrost.day}`, days: dToLast, advice: 'Hold warm-season fertilizing and new seeding until after last frost.', urgency: 'info' };
                                } else if (dToLast >= -14 && dToLast < 0) {
                                    banner = { icon: '‚úÖ', label: 'Frost season ended', days: Math.abs(dToLast), advice: 'Lawn season open ‚Äî time for pre-emergent and spring first fertilizer.', urgency: 'go', past: true };
                                }
                                if (!banner) return null;
                                const colors = {
                                    urgent:  { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', sub: 'text-orange-600' },
                                    warning: { bg: 'bg-amber-50',  border: 'border-amber-200',  text: 'text-amber-700',  sub: 'text-amber-600'  },
                                    go:      { bg: 'bg-green-50',  border: 'border-green-200',  text: 'text-green-700',  sub: 'text-green-600'  },
                                    info:    { bg: 'bg-blue-50',   border: 'border-blue-200',   text: 'text-blue-700',   sub: 'text-blue-500'   },
                                }[banner.urgency];
                                return (
                                    <div className={`${colors.bg} border ${colors.border} rounded-xl px-4 py-3 flex items-start gap-3`}>
                                        <div className="text-xl flex-shrink-0 mt-0.5">{banner.icon}</div>
                                        <div className="flex-1 min-w-0">
                                            <div className={`text-xs font-bold uppercase tracking-widest ${colors.text} mb-0.5`}>
                                                {banner.label} {banner.past ? `(${banner.days}d ago)` : `‚Äî ${banner.days} day${banner.days !== 1 ? 's' : ''}`}
                                            </div>
                                            <div className={`text-xs ${colors.sub}`}>{banner.advice}</div>
                                        </div>
                                    </div>
                                );
                            })()}
                            {/* Primary CTA */}
                            <button onClick={() => { setView('add'); setSelectedActivityType(null); }} className="w-full bg-[#367C2B] hover:bg-[#2d6323] text-white rounded-2xl py-4 flex items-center justify-center gap-3 btn-press transition" style={{boxShadow: '0 4px 18px rgba(54,124,43,0.32)'}}>
                                <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2.5}>
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/>
                                    </svg>
                                </div>
                                <span className="text-base font-extrabold tracking-wide">Log Activity</span>
                            </button>
                            {/* Recent activity strip */}
                            {activities.length > 0 && (() => {
                                const recent = [...activities].reverse().slice(0, 3);
                                return (
                                    <div>
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="text-xs font-bold text-gray-400 uppercase tracking-widest">Recent Activity</div>
                                            <button onClick={() => setView('history')} className="text-xs font-semibold text-[#367C2B]">View all ‚Üí</button>
                                        </div>
                                        <div className="space-y-2">
                                            {recent.map(activity => {
                                                const colors = ACTIVITY_COLORS[activity.type] || ACTIVITY_COLORS.mowing;
                                                const type = ACTIVITY_TYPES[activity.type];
                                                const days = Math.floor((new Date() - new Date(activity.date)) / (1000*60*60*24));
                                                const when = days === 0 ? 'Today' : days === 1 ? 'Yesterday' : `${days} days ago`;
                                                return (
                                                    <div key={activity.id} className="bg-white rounded-xl border border-gray-100 shadow-sm px-3 py-2.5 flex items-center gap-3 card-hover">
                                                        <div className={`w-8 h-8 rounded-lg ${colors.bg} flex items-center justify-center text-base flex-shrink-0`}>{type.icon}</div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="text-sm font-bold text-gray-800">{type.name}</div>
                                                            <div className="text-xs text-gray-400">{when}</div>
                                                        </div>
                                                        <div className="w-2 h-2 rounded-full flex-shrink-0" style={{backgroundColor: colors.hex}}></div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })()}
                            {/* Quick access 2√ó2 */}
                            <div>
                                <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Quick Access</div>
                                <div className="grid grid-cols-2 gap-2.5">
                                    <button onClick={() => setView('profile')} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center gap-3 card-hover btn-press text-left">
                                        <div className="w-10 h-10 rounded-xl bg-[#e8f5e9] flex items-center justify-center flex-shrink-0">
                                            <svg className="w-5 h-5 text-[#367C2B]" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                                            </svg>
                                        </div>
                                        <div><div className="text-sm font-bold text-gray-800">My Lawn</div><div className="text-xs text-gray-400">Profile & care</div></div>
                                    </button>
                                    <button onClick={() => setView('garage')} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center gap-3 card-hover btn-press text-left">
                                        <div className="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
                                            <svg className="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                        </div>
                                        <div><div className="text-sm font-bold text-gray-800">My Garage</div><div className="text-xs text-gray-400">Equipment</div></div>
                                    </button>
                                    <button onClick={() => setView('history')} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center gap-3 card-hover btn-press text-left">
                                        <div className="w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center flex-shrink-0">
                                            <svg className="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                            </svg>
                                        </div>
                                        <div><div className="text-sm font-bold text-gray-800">History</div><div className="text-xs text-gray-400">Past activities</div></div>
                                    </button>
                                    <button onClick={() => setView('dashboard')} className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center gap-3 card-hover btn-press text-left">
                                        <div className="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center flex-shrink-0">
                                            <svg className="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                            </svg>
                                        </div>
                                        <div><div className="text-sm font-bold text-gray-800">Dashboard</div><div className="text-xs text-gray-400">Stats & trends</div></div>
                                    </button>
                                </div>
                            </div>
                            {/* Monthly summary strip */}
                            {(() => {
                                const thisMonth = new Date().getMonth();
                                const thisYear = new Date().getFullYear();
                                const monthActivities = activities.filter(a => { const d = new Date(a.date); return d.getMonth() === thisMonth && d.getFullYear() === thisYear; });
                                const monthCount = monthActivities.length;
                                const lastMow = [...activities].reverse().find(a => a.type === 'mowing');
                                const mowText = lastMow ? (() => { const d = Math.floor((new Date() - new Date(lastMow.date)) / (1000*60*60*24)); return d === 0 ? 'Mowed today' : d === 1 ? 'Mowed yesterday' : `Mowed ${d}d ago`; })() : null;
                                const rainText = weather ? `${weather.rainfall}" rain` : null;
                                const summaryParts = [monthCount > 0 ? `${monthCount} ${monthCount === 1 ? 'activity' : 'activities'}` : null, rainText, mowText].filter(Boolean);
                                if (summaryParts.length === 0) return null;
                                const monthName = new Date().toLocaleString('default', { month: 'long' });
                                return (
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 py-3 flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-lg bg-[#e8f5e9] flex items-center justify-center flex-shrink-0">
                                            <svg className="w-4 h-4 text-[#367C2B]" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-0.5">This Month</div>
                                            <div className="text-sm font-semibold text-gray-700 truncate">{summaryParts.join(' ¬∑ ')}</div>
                                        </div>
                                        <button onClick={() => setView('dashboard')} className="text-xs font-bold text-[#367C2B] flex-shrink-0">{monthName} ‚Üí</button>
                                    </div>
                                );
                            })()}
                        </div>
                    )}
                    {view === 'add' && <div><button onClick={() => { setView(null); setSelectedActivityType(null); }} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button>{!selectedActivityType && <ActivitySelector />}{selectedActivityType && <ActivityForm />}</div>}
                    {view === 'history' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><HistoryView /></div>}
                    {view === 'garage' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><MyGarage /></div>}
                    {view === 'profile' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><LawnProfile /></div>}
                    {view === 'gameplan' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><YearlyGameplan /></div>}
                    {view === 'dashboard' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><Dashboard /></div>}
                    {view === 'products' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><ProductGuide /></div>}
                    {view === 'sources' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><ResearchSourcesPage /></div>}
                    {view === 'settings' && <div><button onClick={() => setView(null)} className="text-[#367C2B] mb-4 btn-press font-semibold">‚Üê Back</button><Settings /></div>}
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<LawnCareTracker />);
</script>
```

</body>
</html>
